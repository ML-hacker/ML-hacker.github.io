

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title>关于N1 star给的一道题的审计分析 - Delete&#39;s blog</title><meta name="Description" content=""><meta property="og:title" content="关于N1 star给的一道题的审计分析" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://ML-hacker.github.io/posts/n1start/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-22T10:16:03+08:00" />
<meta property="article:modified_time" content="2024-01-22T10:16:03+08:00" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="关于N1 star给的一道题的审计分析"/>
<meta name="twitter:description" content=""/>
<meta name="application-name" content="Delete&#39;s blog">
<meta name="apple-mobile-web-app-title" content="Delete&#39;s blog">

<meta name="theme-color" content="#f8f8f8"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="canonical" href="http://ML-hacker.github.io/posts/n1start/" /><link rel="prev" href="http://ML-hacker.github.io/posts/phar/" /><link rel="next" href="http://ML-hacker.github.io/posts/knightctf-2024/" />
<link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/color.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "关于N1 star给的一道题的审计分析",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http://ML-hacker.github.io/posts/n1start/"
        },"genre": "posts","keywords": "Thinkphp, PHP","wordcount":  8423 ,
        "url": "http://ML-hacker.github.io/posts/n1start/","datePublished": "2024-01-22T10:16:03+08:00","dateModified": "2024-01-22T10:16:03+08:00","publisher": {
            "@type": "Organization",
            "name": "Delete"},"author": {
                "@type": "Person",
                "name": "Delete"
            },"description": ""
    }
    </script></head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark'); window.theme = theme;   window.isDark = window.theme !== 'light' }
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('' === 'light' || '' === 'dark' || '' === 'black') setTheme(''), saveTheme(''); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
        window.switchThemeEventSet = new Set()
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Delete&#39;s blog"><span id="desktop-header-typeit" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about"> About </a><a class="menu-item" href="/friend"> Friend </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-select" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                    <select class="color-theme-select" id="theme-select-desktop" title="Switch Theme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="black">Black</option>
                        <option value="auto">Auto</option>
                    </select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Delete&#39;s blog"><span id="mobile-header-typeit" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about" title="">About</a><a class="menu-item" href="/friend" title="">Friend</a><a href="javascript:void(0);" class="menu-item theme-select" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
                <select class="color-theme-select" id="theme-select-mobile" title="Switch Theme">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="black">Black</option>
                    <option value="auto">Auto</option>
                </select>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><article class="page single"><h1 class="single-title animate__animated animate__flipInX">关于N1 star给的一道题的审计分析</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><span class="author fas fa-user-circle fa-fw"></span><a href="https://github.com/ML-hacker" title="Author" target="_blank" rel="noopener noreferrer author" class="author">Delete</a>
                </span>&nbsp;<span class="post-category">included in </span>&nbsp;<span class="post-category">category <a href="/categories/web/"><i class="far fa-folder fa-fw"></i>WEB</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2024-01-22">2024-01-22</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2024-01-22">2024-01-22</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;8423 words&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;40 minutes&nbsp;</div>
        </div><div class="content" id="content"><p>#单纯请求跟进代码(在路由处打了两个断点)：
IndexController.class.php -&gt; function Index() -&gt; 调用 <code>I</code> 方法 I</p>
<blockquote>
<p>I (&lsquo;cid&rsquo;,0,&lsquo;intval&rsquo;);</p>
</blockquote>
<h2 id="function-i" class="headerLink">
    <a href="#function-i" class="header-mark"></a>function I()</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 获取输入参数 支持过滤和默认值
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 使用方法:
</span></span></span><span class="line"><span class="cl"><span class="sd"> * &lt;code&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd"> * I(&#39;id&#39;,0); 获取id参数 自动判断get或者post
</span></span></span><span class="line"><span class="cl"><span class="sd"> * I(&#39;post.name&#39;,&#39;&#39;,&#39;htmlspecialchars&#39;); 获取$_POST[&#39;name&#39;]
</span></span></span><span class="line"><span class="cl"><span class="sd"> * I(&#39;get.&#39;); 获取$_GET
</span></span></span><span class="line"><span class="cl"><span class="sd"> * &lt;/code&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param string $name 变量的名称 支持指定类型
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param mixed $default 不存在的时候默认值
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param mixed $filter 参数过滤方法
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param mixed $datas 要获取的额外数据源
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">I</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$default</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$filter</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$datas</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="nv">$_PUT</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">))</span>         <span class="c1">// 指定修饰符
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">list</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$type</span><span class="p">)</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$name</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">C</span><span class="p">(</span><span class="s1">&#39;VAR_AUTO_STRING&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 默认强制转换为字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$type</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 指定参数来源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">list</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="nv">$name</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 默认为自动判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$method</span> <span class="o">=</span> <span class="s1">&#39;param&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="nx">strtolower</span><span class="p">(</span><span class="nv">$method</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s1">&#39;get&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$input</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$_GET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s1">&#39;post&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$input</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$_POST</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s1">&#39;put&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">is_null</span><span class="p">(</span><span class="nv">$_PUT</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">parse_str</span><span class="p">(</span><span class="nx">file_get_contents</span><span class="p">(</span><span class="s1">&#39;php://input&#39;</span><span class="p">),</span> <span class="nv">$_PUT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$input</span> <span class="o">=</span> <span class="nv">$_PUT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s1">&#39;param&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;REQUEST_METHOD&#39;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s1">&#39;POST&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$input</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s1">&#39;PUT&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nx">is_null</span><span class="p">(</span><span class="nv">$_PUT</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">parse_str</span><span class="p">(</span><span class="nx">file_get_contents</span><span class="p">(</span><span class="s1">&#39;php://input&#39;</span><span class="p">),</span> <span class="nv">$_PUT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$input</span> <span class="o">=</span> <span class="nv">$_PUT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$input</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s1">&#39;path&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$input</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$depr</span>  <span class="o">=</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;URL_PATHINFO_DEPR&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$input</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="nv">$depr</span><span class="p">,</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">],</span> <span class="nv">$depr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s1">&#39;request&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$input</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$_REQUEST</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s1">&#39;session&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$input</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$_SESSION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s1">&#39;cookie&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$input</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$_COOKIE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s1">&#39;server&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$input</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$_SERVER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s1">&#39;globals&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$input</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$GLOBALS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s1">&#39;data&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$input</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$datas</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="o">==</span> <span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取全部变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$data</span>    <span class="o">=</span> <span class="nv">$input</span><span class="p">;</span>   
</span></span><span class="line"><span class="cl">        <span class="nv">$filters</span> <span class="o">=</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$filter</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$filter</span> <span class="o">:</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DEFAULT_FILTER&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$filters</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">is_string</span><span class="p">(</span><span class="nv">$filters</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$filters</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nv">$filters</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$filters</span> <span class="k">as</span> <span class="nv">$filter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$data</span> <span class="o">=</span> <span class="nx">array_map_recursive</span><span class="p">(</span><span class="nv">$filter</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span> <span class="c1">// 参数过滤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$input</span><span class="p">[</span><span class="nv">$name</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 取值操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$data</span>    <span class="o">=</span> <span class="nv">$input</span><span class="p">[</span><span class="nv">$name</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$filters</span> <span class="o">=</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$filter</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$filter</span> <span class="o">:</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DEFAULT_FILTER&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$filters</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">is_string</span><span class="p">(</span><span class="nv">$filters</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">===</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$filters</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!==</span> <span class="nx">preg_match</span><span class="p">(</span><span class="nv">$filters</span><span class="p">,</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 支持正则验证
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="k">return</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$default</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$default</span> <span class="o">:</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$filters</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nv">$filters</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">is_int</span><span class="p">(</span><span class="nv">$filters</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$filters</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$filters</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$filters</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$filters</span> <span class="k">as</span> <span class="nv">$filter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nx">function_exists</span><span class="p">(</span><span class="nv">$filter</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$data</span> <span class="o">=</span> <span class="nx">is_array</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="o">?</span> <span class="nx">array_map_recursive</span><span class="p">(</span><span class="nv">$filter</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="o">:</span> <span class="nv">$filter</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span> <span class="c1">// 参数过滤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$data</span> <span class="o">=</span> <span class="nx">filter_var</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nx">is_int</span><span class="p">(</span><span class="nv">$filter</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$filter</span> <span class="o">:</span> <span class="nx">filter_id</span><span class="p">(</span><span class="nv">$filter</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="k">return</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$default</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$default</span> <span class="o">:</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$type</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span> <span class="p">(</span><span class="nx">strtolower</span><span class="p">(</span><span class="nv">$type</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="s1">&#39;a&#39;</span><span class="o">:</span>    <span class="c1">// 数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nv">$data</span> <span class="o">=</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="s1">&#39;d&#39;</span><span class="o">:</span>    <span class="c1">// 数字
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nv">$data</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="s1">&#39;f&#39;</span><span class="o">:</span>    <span class="c1">// 浮点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nv">$data</span> <span class="o">=</span> <span class="p">(</span><span class="nx">float</span><span class="p">)</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="s1">&#39;b&#39;</span><span class="o">:</span>    <span class="c1">// 布尔
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nv">$data</span> <span class="o">=</span> <span class="p">(</span><span class="nx">boolean</span><span class="p">)</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="s1">&#39;s&#39;</span><span class="o">://</span> <span class="nx">字符串</span>
</span></span><span class="line"><span class="cl">                <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$data</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 变量默认值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$data</span> <span class="o">=</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$default</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$default</span> <span class="o">:</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">is_array</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">array_walk_recursive</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="s1">&#39;think_filter&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看见传入的值$\name=$cid, default=0,datas=null
我们把值带进去走一遍
首先，cid传入后先进行了一个判断</p>
<blockquote>
<p>if (strpos($name, &lsquo;/&rsquo;))</p>
</blockquote>
<p>strpos函数就是一个字符串函数
用法:</p>
<blockquote>
<p><strong>strpos</strong>(string <code>$haystack</code>, string <code>$needle</code>, int <code>$offset</code> = 0): int|false</p>
</blockquote>
<p>string haystack是被查找的字符串，string needle 是需要查找的字符串
所以在这里面就是在<code>$name</code>里面查找<code>/</code>返回索引值，若没找到那就是返回false</p>
<p>所以这里传参进去，这里返回的会是false因为<code>$name = cid</code>不带有 <code>/</code>
所以这里直接跳到<code>elseif</code>处</p>
<hr>
<p><strong>可以省略不看</strong>
看到这里了索性就去看了下explod()函数和list函数:</p>
<blockquote>
<p>list($name, $type) = explode(&rsquo;/&rsquo;, $name, 2);</p>
</blockquote>
<p>前面的strpos将$name中的<code>\</code>检测出来，若存在则将$name中的<code>\</code>分离出来，并且最大分离为2</p>
<hr>
<p>跟进下面，若传入的name没有分割符，则直接跳到Function C</p>
<h2 id="function-c" class="headerLink">
    <a href="#function-c" class="header-mark"></a>Function C()</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="sd">/**  
</span></span></span><span class="line"><span class="cl"><span class="sd">* 获取和设置配置参数 支持批量定义  
</span></span></span><span class="line"><span class="cl"><span class="sd">* @param string|array $name 配置变量  
</span></span></span><span class="line"><span class="cl"><span class="sd">* @param mixed $value 配置值  
</span></span></span><span class="line"><span class="cl"><span class="sd">* @param mixed $default 默认值  
</span></span></span><span class="line"><span class="cl"><span class="sd">* @return mixed  
</span></span></span><span class="line"><span class="cl"><span class="sd">*/</span>  
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">C</span><span class="p">(</span><span class="nv">$name</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$value</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$default</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="nv">$_config</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// 无参数时获取所有  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$name</span><span class="p">))</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="nv">$_config</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// 优先执行设置获取或赋值  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">is_string</span><span class="p">(</span><span class="nv">$name</span><span class="p">))</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">))</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="nv">$name</span> <span class="o">=</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">is_null</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$_config</span><span class="p">[</span><span class="nv">$name</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_config</span><span class="p">[</span><span class="nv">$name</span><span class="p">]</span> <span class="o">:</span> <span class="nv">$default</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="nv">$_config</span><span class="p">[</span><span class="nv">$name</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="k">null</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// 二维数组设置和获取支持  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nv">$name</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="nv">$name</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="nv">$name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nv">$name</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">is_null</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$_config</span><span class="p">[</span><span class="nv">$name</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="nv">$name</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">?</span> <span class="nv">$_config</span><span class="p">[</span><span class="nv">$name</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="nv">$name</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">:</span> <span class="nv">$default</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="nv">$_config</span><span class="p">[</span><span class="nv">$name</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="nv">$name</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="k">null</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// 批量设置  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$name</span><span class="p">))</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="nv">$_config</span> <span class="o">=</span> <span class="nx">array_merge</span><span class="p">(</span><span class="nv">$_config</span><span class="p">,</span> <span class="nx">array_change_key_case</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nx">CASE_UPPER</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="k">null</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="k">null</span><span class="p">;</span> <span class="c1">// 避免非法参数  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先看见function c中有三个参数需要传入分别为:<code>$name</code>、<code>$value</code>、<code>default</code></p>
<p><code>VAR_AUTO_STRING</code>将$name强制转化为string类型，
第一个if判断
传入(string)cid，- &gt; 判断是否为字符串 - &gt;如果没有<code>.</code>号 - &gt; 利用<code>strtoupper</code>函数将$name 转化为大写，
第二个if
判断value值是否为null，因为前面没有传递value，所以根据函数定义默认为null，所以返回ture，所以就到 - &gt;return isset($_config[$name]) ? $_config[$name] : $default;  三元运算符，
这里var_dump了一下发现是没有CID这个键值的所以最后将CID的键值赋值为null了。</p>
<p>因为这里强制转换了字符串所以就不会触发二维数组的设置了，然后就到批量设置
若$name是数组，则利用<code>array_change_key_case</code>函数将<code>name</code>所有的键值转化为大写，然后讲这些内容合并到$_config里面，
若不是数组则直接执行return null;</p>
<p>然后回到function I()里面继续走
这里把 #type = &rsquo;s&rsquo;了</p>
<p>然后到后面的if判断，因为传入的name是cid没有带<code>.</code>号所以直接跳到else后面
直接把 #method设置为&rsquo;param&rsquo; 默认为自动判断类型</p>
<p>然后后面的switch对请求方法进行了判断也就是判断请求方式是什么
然后这里有个特殊的点，当param=&lsquo;put&rsquo;时</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">parse_str</span><span class="p">(</span><span class="nx">file_get_contents</span><span class="p">(</span><span class="s1">&#39;php://input&#39;</span><span class="p">),</span> <span class="nv">$_PUT</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先是<code>file_get_contents</code>函数读取来自php的输入流，然后通过<code>parse_str()</code>函数将查询字符串解析为变量，然后存在$_PUT数组中</p>
<p>但是这里因为method直接默认为<code>paramter</code>
所以直接跳入 param 的 case，这里先让它默认判断为get</p>
<p>这里debug了一下分为两个过程</p>
<p>1、如果不传值 -&gt; is_array($data) &amp;&amp; array_walk_recursive($data, &rsquo;think_filter&rsquo;);
2、如果传入值 cid=1</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">elseif</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$input</span><span class="p">[</span><span class="nv">$name</span><span class="p">]))</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">// 取值操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$data</span>    <span class="o">=</span> <span class="nv">$input</span><span class="p">[</span><span class="nv">$name</span><span class="p">];</span>  <span class="c1">// $name:&#34;cid&#34;  $input:{cid =&gt; &#34;1&#34;}[&#34;1&#34;]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$filters</span> <span class="o">=</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$filter</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$filter</span> <span class="o">:</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DEFAULT_FILTER&#39;</span><span class="p">);</span> <span class="c1">//$filter: &#34;intval&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nv">$filters</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">is_string</span><span class="p">(</span><span class="nv">$filters</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">===</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$filters</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">))</span> <span class="p">{</span> <span class="nv">$filter</span><span class="o">:</span> <span class="s2">&#34;intval&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!==</span> <span class="nx">preg_match</span><span class="p">(</span><span class="nv">$filters</span><span class="p">,</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 支持正则验证
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="k">return</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$default</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$default</span> <span class="o">:</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$filters</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nv">$filters</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">is_int</span><span class="p">(</span><span class="nv">$filters</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$filters</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$filters</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$filters</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$filters</span> <span class="k">as</span> <span class="nv">$filter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nx">function_exists</span><span class="p">(</span><span class="nv">$filter</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$data</span> <span class="o">=</span> <span class="nx">is_array</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="o">?</span> <span class="nx">array_map_recursive</span><span class="p">(</span><span class="nv">$filter</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="o">:</span> <span class="nv">$filter</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span> <span class="c1">// 参数过滤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$data</span> <span class="o">=</span> <span class="nx">filter_var</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nx">is_int</span><span class="p">(</span><span class="nv">$filter</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$filter</span> <span class="o">:</span> <span class="nx">filter_id</span><span class="p">(</span><span class="nv">$filter</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="k">return</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$default</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$default</span> <span class="o">:</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$type</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span> <span class="p">(</span><span class="nx">strtolower</span><span class="p">(</span><span class="nv">$type</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="s1">&#39;a&#39;</span><span class="o">:</span>    <span class="c1">// 数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nv">$data</span> <span class="o">=</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="s1">&#39;d&#39;</span><span class="o">:</span>    <span class="c1">// 数字
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nv">$data</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="s1">&#39;f&#39;</span><span class="o">:</span>    <span class="c1">// 浮点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nv">$data</span> <span class="o">=</span> <span class="p">(</span><span class="nx">float</span><span class="p">)</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="s1">&#39;b&#39;</span><span class="o">:</span>    <span class="c1">// 布尔
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nv">$data</span> <span class="o">=</span> <span class="p">(</span><span class="nx">boolean</span><span class="p">)</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="s1">&#39;s&#39;</span><span class="o">://</span> <span class="nx">字符串</span>
</span></span><span class="line"><span class="cl">                <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$data</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>做了 #filter= intval 的过滤，也就是只能传入整数型数字
跳到对于filter的判断，$filter中没有<code>/</code>所以不会跳入preg_matc进行正则，</p>
<p>继续跟进:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$filters</span><span class="p">))</span> <span class="c1">//$filter: {&#34;intval&#34;}[&#34;intval&#34;]
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>判断完成后，遍历filter的值(这里var_dump了一下，只有</p>
<blockquote>
<p>array(1) {[0] = &gt; string(6)&ldquo;intval&rdquo;}</p>
</blockquote>
<p>filter函数存在
并且debug发现data的值为1不为数组，所以进入三元运算</p>
<h3 id="function-array_map_recurisive" class="headerLink">
    <a href="#function-array_map_recurisive" class="header-mark"></a>function array_map_recurisive()</h3><p>这里的array_map_recurisive()函数为:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">array_map_recursive</span><span class="p">(</span><span class="nv">$filter</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$result</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$data</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$result</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">is_array</span><span class="p">(</span><span class="nv">$val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">?</span> <span class="nx">array_map_recursive</span><span class="p">(</span><span class="nv">$filter</span><span class="p">,</span> <span class="nv">$val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span> <span class="nx">call_user_func</span><span class="p">(</span><span class="nv">$filter</span><span class="p">,</span> <span class="nv">$val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>这个函数有两个参数: $filter和 $data。 $filer是一个回调函数，用于处理数组中的每个元素；$data则是需要处理的多维数组。</li>
<li>函数先创建了一个$result变量来存储处理后的结果。</li>
<li>然后，通过&rsquo;foreach&rsquo;循环遍历输入的<code>$data</code>数组，对于数组中的每个元素执行以下操作：
<ul>
<li>如果当前遍历到的元素<code>$val</code>是一个数组返回true，那么就会对这个子数组递归调用<code>array\_map\_recurisive函数</code>，并且将字数组的每个元素传递给<code>$filter</code>处理。</li>
<li>如果遍历到的元素不是数组，那么就将这个元素传递给filter进行处理。</li>
</ul>
</li>
<li>最后传回result里面。</li>
</ul>
<p>最后到</p>
<blockquote>
<p>is_array($data) &amp;&amp; array_walk_recursive($data, &rsquo;think_filter&rsquo;);</p>
</blockquote>
<p>显而易见，这里返回的是false</p>
<p>最后返回$data = 1;
到这里，整个I函数的数据流就分析完了</p>
<p>前面的<code>I</code>函数就走完了，接下来就是</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nv">$cid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">show</span><span class="p">(</span><span class="s1">&#39;&lt;style type=&#34;text/css&#34;&gt;*{ padding: 0; margin: 0; } div{ padding: 4px 48px;} body{ background: #fff; font-family: &#34;微软雅黑&#34;; color: #b80202;font-size:24px} h1{ font-size: 100px; font-weight: normal; margin-bottom: 12px; } p{ line-height: 1.8em; font-size: 36px } a,a:hover{color:blue;}&lt;/style&gt;&lt;div style=&#34;padding: 24px 48px;&#34;&gt; &lt;h1&gt;:)&lt;/h1&gt;&lt;p&gt;欢迎使用 &lt;b&gt;ThinkPHP&lt;/b&gt;！&lt;/p&gt;&lt;br/&gt;版本 V{$Think.version}&lt;/div&gt;&lt;script type=&#34;text/javascript&#34; src=&#34;http://ad.topthink.com/Public/static/client.js&#34;&gt;&lt;/script&gt;&lt;thinkad id=&#34;ad_55e75dfae343f5a1&#34;&gt;&lt;/thinkad&gt;&lt;script type=&#34;text/javascript&#34; src=&#34;http://tajs.qq.com/stats?sId=9347272&#34; charset=&#34;UTF-8&#34;&gt;&lt;/script&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;utf-8&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">page</span><span class="p">(</span><span class="nv">$cid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>先传一个cid = 0;开始跟进</p>
<p>大概流程: -&gt; show()-&gt;view-&gt;display()-&gt;G();-&gt;listen()-&gt;fetch()-&gt;getThemePath-&gt;getTemplateTheme-&gt;C();</p>
<h3 id="function-show" class="headerLink">
    <a href="#function-show" class="header-mark"></a>function show()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">protected</span> <span class="k">function</span> <span class="nf">show</span><span class="p">(</span><span class="nv">$content</span><span class="p">,</span> <span class="nv">$charset</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$contentType</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">view</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$charset</span><span class="p">,</span> <span class="nv">$contentType</span><span class="p">,</span> <span class="nv">$content</span><span class="p">,</span> <span class="nv">$prefix</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>调用了view属性，找了一下继承的控制器<code>Controller.class.php</code>,发现到了这个属性</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">protected</span> <span class="nv">$view</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到上面给show传递了$content和$charset
所以给display传值
再来看一下display函数如何定义的</p>
<h3 id="function-display" class="headerLink">
    <a href="#function-display" class="header-mark"></a>function display()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">display</span><span class="p">(</span><span class="nv">$templateFile</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$charset</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$contentType</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">G</span><span class="p">(</span><span class="s1">&#39;viewStartTime&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 视图开始标签
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">Hook</span><span class="o">::</span><span class="na">listen</span><span class="p">(</span><span class="s1">&#39;view_begin&#39;</span><span class="p">,</span> <span class="nv">$templateFile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 解析并获取模板内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$content</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">(</span><span class="nv">$templateFile</span><span class="p">,</span> <span class="nv">$content</span><span class="p">,</span> <span class="nv">$prefix</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 输出模板内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="nv">$content</span><span class="p">,</span> <span class="nv">$charset</span><span class="p">,</span> <span class="nv">$contentType</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 视图结束标签
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">Hook</span><span class="o">::</span><span class="na">listen</span><span class="p">(</span><span class="s1">&#39;view_end&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>跟进到G函数</p>
<h3 id="function-g" class="headerLink">
    <a href="#function-g" class="header-mark"></a>function G()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 记录和统计时间（微秒）和内存使用情况
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 使用方法:
</span></span></span><span class="line"><span class="cl"><span class="sd"> * &lt;code&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd"> * G(&#39;begin&#39;); // 记录开始标记位
</span></span></span><span class="line"><span class="cl"><span class="sd"> * // ... 区间运行代码
</span></span></span><span class="line"><span class="cl"><span class="sd"> * G(&#39;end&#39;); // 记录结束标签位
</span></span></span><span class="line"><span class="cl"><span class="sd"> * echo G(&#39;begin&#39;,&#39;end&#39;,6); // 统计区间运行时间 精确到小数后6位
</span></span></span><span class="line"><span class="cl"><span class="sd"> * echo G(&#39;begin&#39;,&#39;end&#39;,&#39;m&#39;); // 统计区间内存使用情况
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 如果end标记位没有定义，则会自动以当前作为标记位
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 其中统计内存使用需要 MEMORY_LIMIT_ON 常量为true才有效
</span></span></span><span class="line"><span class="cl"><span class="sd"> * &lt;/code&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param string $start 开始标签
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param string $end 结束标签
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param integer|string $dec 小数位或者m
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">G</span><span class="p">(</span><span class="nv">$start</span><span class="p">,</span> <span class="nv">$end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$dec</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="nv">$_info</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="nv">$_mem</span>  <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">is_float</span><span class="p">(</span><span class="nv">$end</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 记录时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$_info</span><span class="p">[</span><span class="nv">$start</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$end</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 统计时间和内存使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_info</span><span class="p">[</span><span class="nv">$end</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$_info</span><span class="p">[</span><span class="nv">$end</span><span class="p">]</span> <span class="o">=</span> <span class="nx">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">MEMORY_LIMIT_ON</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;m&#39;</span> <span class="o">==</span> <span class="nv">$dec</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_mem</span><span class="p">[</span><span class="nv">$end</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$_mem</span><span class="p">[</span><span class="nv">$end</span><span class="p">]</span> <span class="o">=</span> <span class="nx">memory_get_usage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">number_format</span><span class="p">((</span><span class="nv">$_mem</span><span class="p">[</span><span class="nv">$end</span><span class="p">]</span> <span class="o">-</span> <span class="nv">$_mem</span><span class="p">[</span><span class="nv">$start</span><span class="p">])</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">number_format</span><span class="p">((</span><span class="nv">$_info</span><span class="p">[</span><span class="nv">$end</span><span class="p">]</span> <span class="o">-</span> <span class="nv">$_info</span><span class="p">[</span><span class="nv">$start</span><span class="p">]),</span> <span class="nv">$dec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 记录时间和内存使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$_info</span><span class="p">[</span><span class="nv">$start</span><span class="p">]</span> <span class="o">=</span> <span class="nx">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">MEMORY_LIMIT_ON</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$_mem</span><span class="p">[</span><span class="nv">$start</span><span class="p">]</span> <span class="o">=</span> <span class="nx">memory_get_usage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>参数：</p>
<blockquote>
<p>G($start=&lsquo;viewStartTime&rsquo;,$end=&rsquo;&rsquo;， $dec = 4)</p>
</blockquote>
<p>在<code>$_info</code>、<code>$_mem_</code>后面var_dump了一下，发现都是一些时间和内存的记录
因为end默认是string所以直接跳到</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">        <span class="nv">$_info</span><span class="p">[</span><span class="nv">$start</span><span class="p">]</span> <span class="o">=</span> <span class="nx">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">MEMORY_LIMIT_ON</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$_mem</span><span class="p">[</span><span class="nv">$start</span><span class="p">]</span> <span class="o">=</span> <span class="nx">memory_get_usage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据前面注释可以知道，其实就是<code>记录和统计时间（微秒）和内存使用情况</code>
最后return了null所以就继续跟进</p>
<p>可以看到这里利用了一个<code>Hook</code>的机制(刚好不太懂所以就去顺便学习了一下)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">        <span class="nx">Hook</span><span class="o">::</span><span class="na">listen</span><span class="p">(</span><span class="s1">&#39;view_begin&#39;</span><span class="p">,</span> <span class="nv">$templateFile</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>跟进去  - &gt; listen函数</p>
<h3 id="function-listen" class="headerLink">
    <a href="#function-listen" class="header-mark"></a>function listen()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">listen</span><span class="p">(</span><span class="nv">$tag</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$params</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$tags</span><span class="p">[</span><span class="nv">$tag</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">APP_DEBUG</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">G</span><span class="p">(</span><span class="nv">$tag</span> <span class="o">.</span> <span class="s1">&#39;Start&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nx">trace</span><span class="p">(</span><span class="s1">&#39;[ &#39;</span> <span class="o">.</span> <span class="nv">$tag</span> <span class="o">.</span> <span class="s1">&#39; ] --START--&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;INFO&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">foreach</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$tags</span><span class="p">[</span><span class="nv">$tag</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">APP_DEBUG</span> <span class="o">&amp;&amp;</span> <span class="nx">G</span><span class="p">(</span><span class="nv">$name</span> <span class="o">.</span> <span class="s1">&#39;_start&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$result</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">exec</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$tag</span><span class="p">,</span> <span class="nv">$params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">APP_DEBUG</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">G</span><span class="p">(</span><span class="nv">$name</span> <span class="o">.</span> <span class="s1">&#39;_end&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">trace</span><span class="p">(</span><span class="s1">&#39;Run &#39;</span> <span class="o">.</span> <span class="nv">$name</span> <span class="o">.</span> <span class="s1">&#39; [ RunTime:&#39;</span> <span class="o">.</span> <span class="nx">G</span><span class="p">(</span><span class="nv">$name</span> <span class="o">.</span> <span class="s1">&#39;_start&#39;</span><span class="p">,</span> <span class="nv">$name</span> <span class="o">.</span> <span class="s1">&#39;_end&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;s ]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;INFO&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 如果返回false 则中断插件执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">APP_DEBUG</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 记录行为的执行日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">trace</span><span class="p">(</span><span class="s1">&#39;[ &#39;</span> <span class="o">.</span> <span class="nv">$tag</span> <span class="o">.</span> <span class="s1">&#39; ] --END-- [ RunTime:&#39;</span> <span class="o">.</span> <span class="nx">G</span><span class="p">(</span><span class="nv">$tag</span> <span class="o">.</span> <span class="s1">&#39;Start&#39;</span><span class="p">,</span> <span class="nv">$tag</span> <span class="o">.</span> <span class="s1">&#39;End&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;s ]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;INFO&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里<code>view_begin</code>不存在这个键，所以直接跳到ruturn
所以跟进到：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$content</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">(</span><span class="nv">$templateFile</span><span class="p">,</span> <span class="nv">$content</span><span class="p">,</span> <span class="nv">$prefix</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="function-fetch" class="headerLink">
    <a href="#function-fetch" class="header-mark"></a>function fetch()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 解析和获取模板内容 用于输出
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access public
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param string $templateFile 模板文件名
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param string $content 模板输出内容
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param string $prefix 模板缓存前缀
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return string
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">fetch</span><span class="p">(</span><span class="nv">$templateFile</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$content</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$templateFile</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseTemplate</span><span class="p">(</span><span class="nv">$templateFile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 模板文件不存在直接返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">is_file</span><span class="p">(</span><span class="nv">$templateFile</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">E</span><span class="p">(</span><span class="nx">L</span><span class="p">(</span><span class="s1">&#39;_TEMPLATE_NOT_EXIST_&#39;</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;:&#39;</span> <span class="o">.</span> <span class="nv">$templateFile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">defined</span><span class="p">(</span><span class="s1">&#39;THEME_PATH&#39;</span><span class="p">)</span> <span class="k">or</span> <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;THEME_PATH&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getThemePath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 页面缓存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">ob_start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ob_implicit_flush</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;php&#39;</span> <span class="o">==</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nx">C</span><span class="p">(</span><span class="s1">&#39;TMPL_ENGINE_TYPE&#39;</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 使用PHP原生模板
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$_content</span> <span class="o">=</span> <span class="nv">$content</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 模板阵列变量分解成为独立变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">extract</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tVar</span><span class="p">,</span> <span class="nx">EXTR_OVERWRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 直接载入PHP模板
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">empty</span><span class="p">(</span><span class="nv">$_content</span><span class="p">)</span> <span class="o">?</span> <span class="k">include</span> <span class="nv">$templateFile</span> <span class="o">:</span> <span class="k">eval</span><span class="p">(</span><span class="s1">&#39;?&gt;&#39;</span> <span class="o">.</span> <span class="nv">$_content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 视图解析标签
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$params</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;var&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tVar</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span> <span class="o">=&gt;</span> <span class="nv">$templateFile</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span> <span class="o">=&gt;</span> <span class="nv">$content</span><span class="p">,</span> <span class="s1">&#39;prefix&#39;</span> <span class="o">=&gt;</span> <span class="nv">$prefix</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Hook</span><span class="o">::</span><span class="na">listen</span><span class="p">(</span><span class="s1">&#39;view_parse&#39;</span><span class="p">,</span> <span class="nv">$params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取并清空缓存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$content</span> <span class="o">=</span> <span class="nx">ob_get_clean</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 内容过滤标签
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">Hook</span><span class="o">::</span><span class="na">listen</span><span class="p">(</span><span class="s1">&#39;view_filter&#39;</span><span class="p">,</span> <span class="nv">$content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 输出模板文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>1、<code>content</code>不为空-&gt;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"> <span class="nx">defined</span><span class="p">(</span><span class="s1">&#39;THEME_PATH&#39;</span><span class="p">)</span> <span class="k">or</span> <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;THEME_PATH&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getThemePath</span><span class="p">());</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为跟进后发现进入了getThemePath函数，所以可以判断‘THEME_PATH’没有被定义</p>
<h3 id="function-getthemepath" class="headerLink">
    <a href="#function-getthemepath" class="header-mark"></a>function getThemePath()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="sd">/**  
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 获取当前的模板路径  
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @access protected  
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param  string $module 模块名  
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @return string  
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>  
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="k">function</span> <span class="nf">getThemePath</span><span class="p">(</span><span class="nv">$module</span> <span class="o">=</span> <span class="nx">MODULE_NAME</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// 获取当前主题名称  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$theme</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getTemplateTheme</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// 获取当前主题的模版路径  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$tmplPath</span> <span class="o">=</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;VIEW_PATH&#39;</span><span class="p">);</span> <span class="c1">// 模块设置独立的视图目录  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$tmplPath</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">// 定义TMPL_PATH 则改变全局的视图目录到模块之外  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$tmplPath</span> <span class="o">=</span> <span class="nx">defined</span><span class="p">(</span><span class="s1">&#39;TMPL_PATH&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">TMPL_PATH</span> <span class="o">.</span> <span class="nv">$module</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">:</span> <span class="nx">APP_PATH</span> <span class="o">.</span> <span class="nv">$module</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">.</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DEFAULT_V_LAYER&#39;</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$tmplPath</span> <span class="o">.</span> <span class="nv">$theme</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们接下来跟进 function getThemePath  - &gt; getTemplateTheme();</p>
<h3 id="function-gettemplatetheme" class="headerLink">
    <a href="#function-gettemplatetheme" class="header-mark"></a>function getTemplateTheme()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">function</span> <span class="nf">getTemplateTheme</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">theme</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 指定模板主题
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$theme</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">theme</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* 获取模板主题名称 */</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$theme</span> <span class="o">=</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DEFAULT_THEME&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">C</span><span class="p">(</span><span class="s1">&#39;TMPL_DETECT_THEME&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 自动侦测模板主题
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nv">$t</span> <span class="o">=</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;VAR_TEMPLATE&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$t</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$theme</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="nv">$t</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">cookie</span><span class="p">(</span><span class="s1">&#39;think_template&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$theme</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">(</span><span class="s1">&#39;think_template&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$theme</span><span class="p">,</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;THEME_LIST&#39;</span><span class="p">))))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$theme</span> <span class="o">=</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DEFAULT_THEME&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nx">cookie</span><span class="p">(</span><span class="s1">&#39;think_template&#39;</span><span class="p">,</span> <span class="nv">$theme</span><span class="p">,</span> <span class="mi">864000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">defined</span><span class="p">(</span><span class="s1">&#39;THEME_NAME&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;THEME_NAME&#39;</span><span class="p">,</span> <span class="nv">$theme</span><span class="p">);</span> <span class="c1">// 当前模板主题名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nv">$theme</span> <span class="o">?</span> <span class="nv">$theme</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后这个函数其实就是一直在调用C函数进行配置的读取，后面考虑到这里的参数都不可控，所以直接跳到后面的page路由了</p>
<p>这里就提一嘴：
如果在index路由进行传参会被intval过滤器进行过滤，所以我们直接对page路由进行传参就行了（虽然前面花了大部分时间分析，但是后面有调用到前面的函数就可以很好的去分析了）</p>
<h3 id="page路由" class="headerLink">
    <a href="#page%e8%b7%af%e7%94%b1" class="header-mark"></a>page路由</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">page</span><span class="p">(</span><span class="nv">$cid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nv">$cid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$content</span> <span class="o">=</span> <span class="nx">M</span><span class="p">(</span><span class="s1">&#39;Articles&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">Field</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$cid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">show</span><span class="p">(</span><span class="nx">base64_encode</span><span class="p">(</span><span class="nv">$content</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]),</span><span class="s1">&#39;utf-8&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>避免抛出error所以我们直接传一个<code>cid=1</code></p>
<h3 id="function-m" class="headerLink">
    <a href="#function-m" class="header-mark"></a>function M()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 实例化一个没有模型文件的Model
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param string $name Model名称 支持指定基础模型 例如 MongoModel:User
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param string $tablePrefix 表前缀
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param mixed $connection 数据库连接信息
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @return Think\Model
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">M</span><span class="p">(</span><span class="nv">$name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$tablePrefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$connection</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="nv">$_model</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">list</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="nv">$name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$class</span> <span class="o">=</span> <span class="s1">&#39;Think\\Model&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$guid</span> <span class="o">=</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$connection</span><span class="p">)</span> <span class="o">?</span> <span class="nx">implode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$connection</span><span class="p">)</span> <span class="o">:</span> <span class="nv">$connection</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$tablePrefix</span> <span class="o">.</span> <span class="nv">$name</span> <span class="o">.</span> <span class="s1">&#39;_&#39;</span> <span class="o">.</span> <span class="nv">$class</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_model</span><span class="p">[</span><span class="nv">$guid</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$_model</span><span class="p">[</span><span class="nv">$guid</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$class</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$tablePrefix</span><span class="p">,</span> <span class="nv">$connection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$_model</span><span class="p">[</span><span class="nv">$guid</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>$name = &lsquo;Articles&rsquo;</p>
</blockquote>
<ul>
<li>var_dump($_model)之后发现: array(0){ }，也就是为空,用于存储已创建的模型实例。</li>
<li>如果传入的$name参数中包含冒号，则使用explode进拆分为<code>\$class</code>和<code>\$name</code>两部分</li>
<li>如果<code>$name</code>中不包含冒号，则默认<code>$class</code>= &lsquo;Think\\Model&rsquo;; 表示使用tp的基础模型类</li>
<li>根据传入的参数构建了一个用于唯一标识模型实例的<code>$guid</code>字符串</li>
<li>检查<code>$_model</code>数组中是否已经存在对应的模型实例，如果不存在则创建一个新的模型实例并存储在<code>$_model</code>数组之中</li>
<li>最后返回<code>$guid</code>的模型实例</li>
</ul>
<p>跟进之后发现直接进入了autoload函数
这个地方有点不懂，所以问了一下gpt
gpt是这样解释的：</p>
<pre><code>在PHP中，当使用`new $class`语法创建一个类的实例时，如果该类在当前命名空间或引入的命名空间中没有定义，PHP会调用自动加载类尝试加载此类文件
</code></pre>
<p>也就是自动加载<code>Think\\Model</code>这个类
跟进到</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$_model</span><span class="p">[</span><span class="nv">$guid</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$class</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$tablePrefix</span><span class="p">,</span> <span class="nv">$connection</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到传参:
$guid:&ldquo;Articles_Think|Model&rdquo; $class:&ldquo;Think\Model&rdquo; $_model: array[0]  $connection = &quot; &quot;
$tablePrefix: &quot; &quot;   $name:&ldquo;Articles&rdquo;</p>
<h3 id="function-autoload" class="headerLink">
    <a href="#function-autoload" class="header-mark"></a>function autoload()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">     <span class="o">*</span> <span class="nx">类库自动加载</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="o">@</span><span class="nx">param</span> <span class="nx">string</span> <span class="nv">$class</span> <span class="nx">对象类名</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="o">@</span><span class="k">return</span> <span class="nx">void</span>
</span></span><span class="line"><span class="cl">     <span class="o">*/</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">autoload</span><span class="p">(</span><span class="nv">$class</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 检查是否存在映射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$_map</span><span class="p">[</span><span class="nv">$class</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">include</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$_map</span><span class="p">[</span><span class="nv">$class</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="k">false</span> <span class="o">!==</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="s1">&#39;\\&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$name</span> <span class="o">=</span> <span class="nx">strstr</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="s1">&#39;\\&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;Think&#39;</span><span class="p">,</span> <span class="s1">&#39;Org&#39;</span><span class="p">,</span> <span class="s1">&#39;Behavior&#39;</span><span class="p">,</span> <span class="s1">&#39;Com&#39;</span><span class="p">,</span> <span class="s1">&#39;Vendor&#39;</span><span class="p">))</span> <span class="o">||</span> <span class="nx">is_dir</span><span class="p">(</span><span class="nx">LIB_PATH</span> <span class="o">.</span> <span class="nv">$name</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Library目录下面的命名空间自动定位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nv">$path</span> <span class="o">=</span> <span class="nx">LIB_PATH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 检测自定义命名空间 否则就以模块为命名空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nv">$namespace</span> <span class="o">=</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;AUTOLOAD_NAMESPACE&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$path</span>      <span class="o">=</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$namespace</span><span class="p">[</span><span class="nv">$name</span><span class="p">])</span> <span class="o">?</span> <span class="nx">dirname</span><span class="p">(</span><span class="nv">$namespace</span><span class="p">[</span><span class="nv">$name</span><span class="p">])</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">:</span> <span class="nx">APP_PATH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$path</span> <span class="o">.</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;\\&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$class</span><span class="p">)</span> <span class="o">.</span> <span class="nx">EXT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">is_file</span><span class="p">(</span><span class="nv">$filename</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Win环境下面严格区分大小写
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="nx">IS_WIN</span> <span class="o">&amp;&amp;</span> <span class="k">false</span> <span class="o">===</span> <span class="nx">strpos</span><span class="p">(</span><span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;\\&#39;</span><span class="p">,</span> <span class="nx">realpath</span><span class="p">(</span><span class="nv">$filename</span><span class="p">)),</span> <span class="nv">$class</span> <span class="o">.</span> <span class="nx">EXT</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">include</span> <span class="nv">$filename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="nx">C</span><span class="p">(</span><span class="s1">&#39;APP_USE_NAMESPACE&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 自动加载的类库层
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">foreach</span> <span class="p">(</span><span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;APP_AUTOLOAD_LAYER&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="nv">$layer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="o">-</span><span class="nx">strlen</span><span class="p">(</span><span class="nv">$layer</span><span class="p">))</span> <span class="o">==</span> <span class="nv">$layer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nx">require_cache</span><span class="p">(</span><span class="nx">MODULE_PATH</span> <span class="o">.</span> <span class="nv">$layer</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">.</span> <span class="nv">$class</span> <span class="o">.</span> <span class="nx">EXT</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 根据自动加载路径设置进行尝试搜索
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">foreach</span> <span class="p">(</span><span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;APP_AUTOLOAD_PATH&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="nv">$path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">import</span><span class="p">(</span><span class="nv">$path</span> <span class="o">.</span> <span class="s1">&#39;.&#39;</span> <span class="o">.</span> <span class="nv">$class</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 如果加载类成功则返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>代码逻辑：</p>
<ul>
<li>首先，检查是否存在类名到文件路径的映射关系。如果存在，直接包含该文件。</li>
<li>如果类名包含命名空间<code>\</code>，则会根据命名空间的规则尝试定位类文件
<ul>
<li>如果类名的空间属于<code>Think</code>、<code>Org</code>、<code>Behavior</code>、<code>Com</code>、<code>Vendor</code>或者这些命名空间在<code>LIB_PATH</code>目录下存在，则将此类文件路径设置为<code>LIB_PATH</code></li>
<li>否则，检查是否有自定义的命名空间配置，并根据配置的路径加载文件。</li>
<li>如果以上步骤均未找到对应的类文件，将以当前模块为命名空间进行加载。</li>
</ul>
</li>
<li>如果未使用名空间(<code>C('APP_USE_NAMESPACE')</code>为<code>false</code>)
<ul>
<li>根据配置的类库层(<code>C('APP_AUTOLOAD_LAYER')</code>) 尝试加载类文件</li>
<li>尝试根据配置的自动加载路径(<code>C('APP_AUTOLOAD_PATH')</code>)进行加载</li>
</ul>
</li>
<li>最后，如果成功加载类文件，则返回，否则结束函数执行</li>
</ul>
<p>我在autoload函数开头加了一个
echo &ldquo;autoload函数被调用切值为&rdquo; . $class;
并且在映射判断处加了一个
echo &ldquo;映射存在&rdquo;;
最后得到的结果就是：
autoload被调用了12次，分别是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Think\Storage
</span></span><span class="line"><span class="cl">Think\Storage\Driver\File
</span></span><span class="line"><span class="cl">Think\Log  //映射存在并且被包含
</span></span><span class="line"><span class="cl">Behavior\ReadHtmlCacheBehavior
</span></span><span class="line"><span class="cl">Home\Controller\IndexController
</span></span><span class="line"><span class="cl">Think\Model //映射存在并且被包含
</span></span><span class="line"><span class="cl">Think\Db  //映射存在并且被包含
</span></span><span class="line"><span class="cl">Think\Db\Driver\Mysql
</span></span><span class="line"><span class="cl">Think\Db\Driverfield
</span></span><span class="line"><span class="cl">Behavior\WriteHtmlCacheBehavior
</span></span><span class="line"><span class="cl">Behavior\ShowPageTraceBehavior
</span></span><span class="line"><span class="cl">Think\Log\Driver\File  //映射存在并且被包含
</span></span></code></pre></td></tr></table>
</div>
</div><p>经过了autoload之后就进入了<code>Model.class.php</code>的model类
所以自动调用到__construct函数</p>
<h3 id="function-__construct" class="headerLink">
    <a href="#function-__construct" class="header-mark"></a>function __construct()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$tablePrefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$connection</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 模型初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_initialize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取模型名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$name</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 支持 数据库名.模型名的 定义
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dbName</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">)</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="nv">$name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getModelName</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 设置表前缀
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">is_null</span><span class="p">(</span><span class="nv">$tablePrefix</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 前缀为Null表示没有前缀
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tablePrefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="o">!=</span> <span class="nv">$tablePrefix</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tablePrefix</span> <span class="o">=</span> <span class="nv">$tablePrefix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tablePrefix</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tablePrefix</span> <span class="o">=</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_PREFIX&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 数据库初始化操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 获取数据库操作对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 当前模型有独立的数据库连接信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connection</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$connection</span> <span class="o">:</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connection</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>先进入 __initialize进行初始化</p>
<h3 id="function-_initialize" class="headerLink">
    <a href="#function-_initialize" class="header-mark"></a>function _initialize()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="c1">// 回调方法 初始化模型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">protected</span> <span class="k">function</span> <span class="nf">_initialize</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>传参:
<code>$name : string(8) &quot;Articles&quot; ,\$tablePrefix: string(0) &quot;&quot;, \$connection :string(0) &quot;&quot;</code>
逻辑：</p>
<ul>
<li>设置模型的名称：
<ul>
<li>根据传入的<code>$name</code>参数设置模型的名称，</li>
<li>如传入的模型中包含<code>.</code>，则按照<code>数据库名.模型名</code>的格式解析出数据库名和模型名。</li>
<li>如果传入的模型名或者未在构造函数中设置模型名称，则使用<code>getModelNmae()</code>方法获取模型名称.</li>
</ul>
</li>
<li>设置表前缀：
<ul>
<li>如果传入的<code>$tablePrefix</code>参数为<code>null</code>，则表示没有表前缀。</li>
<li>如果<code>$tablePrefix</code>不为空字符串，则表前缀设置为传入的值。</li>
<li>如果未设置<code>$tablePrefix</code>且模型实例中未定义表前缀，则使用配置文件中的<code>DB_PREFIX</code>设置为表前缀。</li>
</ul>
</li>
<li>数据库初始化操作：
<ul>
<li>调用了<code>db()</code>方法，获取数据库操作对象。</li>
<li>如果当前模型有独立的数据库连接信息，则使用独立连接的信息，否则使用构造函数传入的链接信息。</li>
<li>最后一个<code>true</code>，表示强制重新连接数据库。</li>
</ul>
</li>
</ul>
<p>插一嘴（表前缀是什么？）： （Table Prefix）是指在数据库中表明前添加的一个固定的字符或字符串，通常用于区分不同应用或模块所创建的表，以避免不同应用或者模块之间的表名冲突。</p>
<p>跟进之后，模型的名称就为<code>Articles</code>、表前缀为<code>null</code>，接下来就走到db()方法</p>
<h3 id="function-db" class="headerLink">
    <a href="#function-db" class="header-mark"></a>function db()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 切换当前的数据库连接
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access public
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param integer $linkNum  连接序号
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param mixed $config  数据库连接信息
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param boolean $force 强制重新连接
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return Model
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">db</span><span class="p">(</span><span class="nv">$linkNum</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$config</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$force</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="o">===</span> <span class="nv">$linkNum</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="p">[</span><span class="nv">$linkNum</span><span class="p">])</span> <span class="o">||</span> <span class="nv">$force</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 创建一个新的实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">is_string</span><span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">false</span> <span class="o">===</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$config</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 支持读取配置参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nv">$config</span> <span class="o">=</span> <span class="nx">C</span><span class="p">(</span><span class="nv">$config</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="p">[</span><span class="nv">$linkNum</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Db</span><span class="o">::</span><span class="na">getInstance</span><span class="p">(</span><span class="nv">$config</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="k">null</span> <span class="o">===</span> <span class="nv">$config</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="p">[</span><span class="nv">$linkNum</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">close</span><span class="p">();</span> <span class="c1">// 关闭数据库连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">unset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="p">[</span><span class="nv">$linkNum</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 切换数据库连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="p">[</span><span class="nv">$linkNum</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_after_db</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 字段检测
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">autoCheckFields</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_checkTableInfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑：</p>
<ul>
<li>如果未传入连接编号<code>#$linkNum</code>并且当前模型对象已经存在数据库连接对象<code>$this-&gt;db</code>，则直接返回已存在的数据库连接对象</li>
<li>如果未创建对应连接编号的数据库对象或者设置了强制创建实例(<code>$force</code>为true)，则根据传入的配置信息<code>$config</code>创建一个新的数据库连接实例，并存储在<code>_db</code>数组中</li>
<li>如果传入了<code>null</code>作为<code>$config</code>的参数，则关闭对应连接编号的数据库连接，并将该连接从<code>_db</code>数组中移除。</li>
<li>将当前数据库连接对象，设为刚创建或者已经存在的连接对象。</li>
<li>在数据库切换后，如果设置了模型名称并且使用了自动字段检测(<code>$this-&gt;autoCheckFields</code> = true)则执行<code>_checkTableInfo()</code>方法进行字段检查</li>
<li>最后，返回当前模型对象本身，以便进行链式操作</li>
</ul>
<p>dump了一下this(单纯想看一下有什么):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class Think\Model#7 (21) { protected $db =&gt; NULL private $_db =&gt; array(0) { } protected $pk =&gt; string(2) &#34;id&#34; protected $autoinc =&gt; bool(false) protected $tablePrefix =&gt; string(0) &#34;&#34; protected $name =&gt; string(8) &#34;Articles&#34; protected $dbName =&gt; string(0) &#34;&#34; protected $connection =&gt; string(0) &#34;&#34; protected $tableName =&gt; string(0) &#34;&#34; protected $trueTableName =&gt; string(0) &#34;&#34; protected $error =&gt; string(0) &#34;&#34; protected $fields =&gt; array(0) { } protected $data =&gt; array(0) { } protected $options =&gt; array(0) { } protected $_validate =&gt; array(0) { } protected $_auto =&gt; array(0) { } protected $_map =&gt; array(0) { } protected $_scope =&gt; array(0) { } protected $autoCheckFields =&gt; bool(true) protected $patchValidate =&gt; bool(false) protected $methods =&gt; array(14) { [0] =&gt; string(6) &#34;strict&#34; [1] =&gt; string(5) &#34;order&#34; [2] =&gt; string(5) &#34;alias&#34; [3] =&gt; string(6) &#34;having&#34; [4] =&gt; string(5) &#34;group&#34; [5] =&gt; string(4) &#34;lock&#34; [6] =&gt; string(8) &#34;distinct&#34; [7] =&gt; string(4) &#34;auto&#34; [8] =&gt; string(6) &#34;filter&#34; [9] =&gt; string(8) &#34;validate&#34; [10] =&gt; string(6) &#34;result&#34; [11] =&gt; string(5) &#34;token&#34; [12] =&gt; string(5) &#34;index&#34; [13] =&gt; string(5) &#34;force&#34; } }
</span></span></code></pre></td></tr></table>
</div>
</div><p>db方法后面静态调用了getInstance，因为要加载一个类，所以自动会跳到前面分析过得<code>autoload</code>方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">     <span class="o">*</span> <span class="nx">类库自动加载</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="o">@</span><span class="nx">param</span> <span class="nx">string</span> <span class="nv">$class</span> <span class="nx">对象类名</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="o">@</span><span class="k">return</span> <span class="nx">void</span>
</span></span><span class="line"><span class="cl">     <span class="o">*/</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">autoload</span><span class="p">(</span><span class="nv">$class</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 检查是否存在映射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$_map</span><span class="p">[</span><span class="nv">$class</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">include</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$_map</span><span class="p">[</span><span class="nv">$class</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="k">false</span> <span class="o">!==</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="s1">&#39;\\&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$name</span> <span class="o">=</span> <span class="nx">strstr</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="s1">&#39;\\&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;Think&#39;</span><span class="p">,</span> <span class="s1">&#39;Org&#39;</span><span class="p">,</span> <span class="s1">&#39;Behavior&#39;</span><span class="p">,</span> <span class="s1">&#39;Com&#39;</span><span class="p">,</span> <span class="s1">&#39;Vendor&#39;</span><span class="p">))</span> <span class="o">||</span> <span class="nx">is_dir</span><span class="p">(</span><span class="nx">LIB_PATH</span> <span class="o">.</span> <span class="nv">$name</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Library目录下面的命名空间自动定位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nv">$path</span> <span class="o">=</span> <span class="nx">LIB_PATH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 检测自定义命名空间 否则就以模块为命名空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nv">$namespace</span> <span class="o">=</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;AUTOLOAD_NAMESPACE&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$path</span>      <span class="o">=</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$namespace</span><span class="p">[</span><span class="nv">$name</span><span class="p">])</span> <span class="o">?</span> <span class="nx">dirname</span><span class="p">(</span><span class="nv">$namespace</span><span class="p">[</span><span class="nv">$name</span><span class="p">])</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">:</span> <span class="nx">APP_PATH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$path</span> <span class="o">.</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;\\&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$class</span><span class="p">)</span> <span class="o">.</span> <span class="nx">EXT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">is_file</span><span class="p">(</span><span class="nv">$filename</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Win环境下面严格区分大小写
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="nx">IS_WIN</span> <span class="o">&amp;&amp;</span> <span class="k">false</span> <span class="o">===</span> <span class="nx">strpos</span><span class="p">(</span><span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;\\&#39;</span><span class="p">,</span> <span class="nx">realpath</span><span class="p">(</span><span class="nv">$filename</span><span class="p">)),</span> <span class="nv">$class</span> <span class="o">.</span> <span class="nx">EXT</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">include</span> <span class="nv">$filename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="nx">C</span><span class="p">(</span><span class="s1">&#39;APP_USE_NAMESPACE&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 自动加载的类库层
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">foreach</span> <span class="p">(</span><span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;APP_AUTOLOAD_LAYER&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="nv">$layer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="o">-</span><span class="nx">strlen</span><span class="p">(</span><span class="nv">$layer</span><span class="p">))</span> <span class="o">==</span> <span class="nv">$layer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nx">require_cache</span><span class="p">(</span><span class="nx">MODULE_PATH</span> <span class="o">.</span> <span class="nv">$layer</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">.</span> <span class="nv">$class</span> <span class="o">.</span> <span class="nx">EXT</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 根据自动加载路径设置进行尝试搜索
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">foreach</span> <span class="p">(</span><span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;APP_AUTOLOAD_PATH&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="nv">$path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">import</span><span class="p">(</span><span class="nv">$path</span> <span class="o">.</span> <span class="s1">&#39;.&#39;</span> <span class="o">.</span> <span class="nv">$class</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 如果加载类成功则返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>自动加载完类后进入getInstance方法</p>
<h3 id="function-getinstance" class="headerLink">
    <a href="#function-getinstance" class="header-mark"></a>function getInstance()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 取得数据库类实例
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @static
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access public
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param mixed $config 连接配置
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return Object 返回数据库驱动类
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getInstance</span><span class="p">(</span><span class="nv">$config</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$md5</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">serialize</span><span class="p">(</span><span class="nv">$config</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$instance</span><span class="p">[</span><span class="nv">$md5</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 解析连接参数 支持数组和字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$options</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">parseConfig</span><span class="p">(</span><span class="nv">$config</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 兼容mysqli
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;mysqli&#39;</span> <span class="o">==</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mysql&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 如果采用lite方式 仅支持原生SQL 包括query和execute方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$class</span> <span class="o">=</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;lite&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="s1">&#39;Think\Db\Lite&#39;</span> <span class="o">:</span> <span class="s1">&#39;Think\\Db\\Driver\\&#39;</span> <span class="o">.</span> <span class="nx">ucwords</span><span class="p">(</span><span class="nx">strtolower</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">class_exists</span><span class="p">(</span><span class="nv">$class</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">self</span><span class="o">::</span><span class="nv">$instance</span><span class="p">[</span><span class="nv">$md5</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$class</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 类没有定义
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">E</span><span class="p">(</span><span class="nx">L</span><span class="p">(</span><span class="s1">&#39;_NO_DB_DRIVER_&#39;</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;: &#39;</span> <span class="o">.</span> <span class="nv">$class</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">self</span><span class="o">::</span><span class="nv">$_instance</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$instance</span><span class="p">[</span><span class="nv">$md5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$_instance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>计算配置信息的MD5值作为连接实例的唯一标识，用于检查是否已经存在对应数据库连接实例</li>
<li>如果尚未创建特定配置信息对应数据库连接实例，将解析给定的连接配置信息，并跟进配置信息选择相应的数据库驱动类。</li>
<li>根据配置信息中指定的数据库类型，动态加载对应的数据库驱动类，这里有一个兼容的处理，如果数据库类型是mysqli，则会转化为mysql。</li>
<li>如果对应的数据库驱动类存在，则创建一个新的数据库连接实例，并存储在静态数组<code>self::$instance</code>中。</li>
<li>如果特定的数据库驱动类不存在，则会抛出一个异常，提示数据库驱动类未定义。</li>
<li>最后返回创建的数据库连接实例
跟进后得到的结果</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$md5</span><span class="o">:</span><span class="s2">&#34;14d71035552fef7c92e4b5c611232830&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$config</span><span class="o">=</span><span class="s2">&#34; &#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>跟进到 parseConfig方法</p>
<h3 id="function-parseconfig" class="headerLink">
    <a href="#function-parseconfig" class="header-mark"></a>function parseConfig()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 数据库连接参数解析
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @static
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access private
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param mixed $config
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return array
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">parseConfig</span><span class="p">(</span><span class="nv">$config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$config</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">is_string</span><span class="p">(</span><span class="nv">$config</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="na">parseDsn</span><span class="p">(</span><span class="nv">$config</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$config</span> <span class="o">=</span> <span class="nx">array_change_key_case</span><span class="p">(</span><span class="nv">$config</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$config</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;type&#39;</span>        <span class="o">=&gt;</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_type&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;username&#39;</span>    <span class="o">=&gt;</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_user&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;password&#39;</span>    <span class="o">=&gt;</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_pwd&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;hostname&#39;</span>    <span class="o">=&gt;</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_host&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;hostport&#39;</span>    <span class="o">=&gt;</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_port&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;database&#39;</span>    <span class="o">=&gt;</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_name&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;dsn&#39;</span>         <span class="o">=&gt;</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_dsn&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_dsn&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;params&#39;</span>      <span class="o">=&gt;</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_params&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_params&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;charset&#39;</span>     <span class="o">=&gt;</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_charset&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_charset&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;deploy&#39;</span>      <span class="o">=&gt;</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_deploy_type&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_deploy_type&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;rw_separate&#39;</span> <span class="o">=&gt;</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_rw_separate&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_rw_separate&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;master_num&#39;</span>  <span class="o">=&gt;</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_master_num&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_master_num&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;slave_no&#39;</span>    <span class="o">=&gt;</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_slave_no&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_slave_no&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;debug&#39;</span>       <span class="o">=&gt;</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_debug&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_debug&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="nx">APP_DEBUG</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;lite&#39;</span>        <span class="o">=&gt;</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_lite&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;db_lite&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$config</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;type&#39;</span>        <span class="o">=&gt;</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_TYPE&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;username&#39;</span>    <span class="o">=&gt;</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_USER&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;password&#39;</span>    <span class="o">=&gt;</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_PWD&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;hostname&#39;</span>    <span class="o">=&gt;</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_HOST&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;hostport&#39;</span>    <span class="o">=&gt;</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_PORT&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;database&#39;</span>    <span class="o">=&gt;</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_NAME&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;dsn&#39;</span>         <span class="o">=&gt;</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_DSN&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;params&#39;</span>      <span class="o">=&gt;</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_PARAMS&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;charset&#39;</span>     <span class="o">=&gt;</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_CHARSET&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;deploy&#39;</span>      <span class="o">=&gt;</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_DEPLOY_TYPE&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;rw_separate&#39;</span> <span class="o">=&gt;</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_RW_SEPARATE&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;master_num&#39;</span>  <span class="o">=&gt;</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_MASTER_NUM&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;slave_no&#39;</span>    <span class="o">=&gt;</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_SLAVE_NO&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;debug&#39;</span>       <span class="o">=&gt;</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_DEBUG&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nx">APP_DEBUG</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;lite&#39;</span>        <span class="o">=&gt;</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_LITE&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$config</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这是一个私有的静态方法。
逻辑：</p>
<ul>
<li>接收一个数据库连接配置数组<code>$config</code>或从配置文件中读取数据库连接配置信息</li>
<li>如果传入了非空的配置数组<code>$config</code>，则跟进数组键名不区分大小写的特性，将数组键名统一转化为小写，并从给定的配置数组中提取数据库连接所需要的参数，参数包括：
<ul>
<li>数据库类型</li>
<li>用户名</li>
<li>主机名</li>
<li>密码</li>
<li>主机端口</li>
<li>数据库名</li>
<li>数据库DSN</li>
<li>连接参数</li>
<li>字符集</li>
<li>数据库部署方式</li>
<li>读写分离</li>
<li>主服务器数量</li>
<li>从服务器编号</li>
<li>调试模式</li>
<li>是否使用轻量级数据库</li>
</ul>
</li>
<li>如果没有传入配置数组<code>$config</code>，则从系统的全局之中读取相同的数据库连接参数，即用上面所说的C（）方法进行获取</li>
<li>返回整理后的数据库连接配置数组</li>
</ul>
<p>然后因为上面的<code>$config</code>为空，所以直接利用C（）方法去获取配置。
获取一下然后dump出来看看</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;type&#39;</span>     <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="s2">&#34;mysql&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;root&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;root123&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;hostname&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="s2">&#34;127.0.0.1&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;hostport&#39;</span> <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">3306</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;database&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="s2">&#34;web&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;dsn&#39;</span>      <span class="o">=&gt;</span> <span class="k">NULL</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;params&#39;</span>   <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;charset&#39;</span>  <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;utf8&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;deploy&#39;</span>   <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;rw_separate&#39;</span> <span class="o">=&gt;</span> <span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;master_num&#39;</span><span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;slave_no&#39;</span>  <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;debug&#39;</span>     <span class="o">=&gt;</span> <span class="nx">bool</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="nx">lite</span><span class="err">&#39;</span>       <span class="o">=&gt;</span> <span class="k">NULL</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>回到db方法，
在几个判断处打了一个断点且用echo测试
发现：</p>
<ul>
<li>type为mysql不需要转化</li>
<li><code>$option['lite']</code>为空即<code>$class</code>的值为<code>Think\Db\Driver\Mysql</code></li>
<li><code>$clas</code>被定义且静态调用instance方法，实例化一个对象</li>
</ul>
<p>然后就到了<code>Drive.class.php</code>中的__construct方法
这个时候有点好奇为什么不是经过autoload方法而是直接进入Driver类，
就去问了一下师傅，说是经历过autoload加载后的类就不需要再autoload了，所以就直接进入对应的类。（使用get_decleared_classes就可以看见被声明过的类了）</p>
<h3 id="function-__construct-in-driveclassphp" class="headerLink">
    <a href="#function-__construct-in-driveclassphp" class="header-mark"></a>function __construct() in Drive.class.php</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 架构函数 读取数据库配置信息
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access public
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param array $config 数据库配置数组
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$config</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>   <span class="k">echo</span> <span class="s2">&#34;Drive类的construct方法被调用！</span><span class="se">\r\n</span><span class="s2">&#34;</span><span class="p">;</span> <span class="c1">//自己添加用于测试
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$config</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span> <span class="o">=</span> <span class="nx">array_merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="p">,</span> <span class="nv">$config</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑</p>
<ul>
<li>如果传入了<code>$config</code>参数，会将传入的配置信息与当前实例的配置信息进行合并，<code>$config</code>参数可以包含数据库连接需要的各种参数</li>
<li>如果<code>$this-&gt;$config['params']</code>是一个数组，会将其合并到<code>$this-&gt;option</code>数组中。</li>
</ul>
<p>然后同样dump了一下，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$this</span><span class="o">-&gt;</span><span class="nv">$config</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"> <span class="k">array</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="p">{</span> <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="s2">&#34;mysql&#34;</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;hostname&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="s2">&#34;127.0.0.1&#34;</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;database&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="s2">&#34;web&#34;</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;root&#34;</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;root123&#34;</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;hostport&#39;</span> <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">3306</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;dsn&#39;</span> <span class="o">=&gt;</span> <span class="k">NULL</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;params&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;charset&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;utf8&#34;</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;prefix&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;debug&#39;</span> <span class="o">=&gt;</span> <span class="nx">bool</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;deploy&#39;</span> <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;rw_separate&#39;</span> <span class="o">=&gt;</span> <span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;master_num&#39;</span> <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;slave_no&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;db_like_fields&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;lite&#39;</span> <span class="o">=&gt;</span> <span class="k">NULL</span> 
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span>
</span></span><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>跟进后返回到db方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">      <span class="c1">// 切换数据库连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="p">[</span><span class="nv">$linkNum</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_after_db</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 字段检测
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">autoCheckFields</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_checkTableInfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>dump出<code>$this-&gt;db</code>的值</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">D</span><span class="o">:</span><span class="nx">\phpstudy_pro\WWW\N1start\tp\ThinkPHP\Library\Think\Model</span><span class="o">.</span><span class="nx">class</span><span class="o">.</span><span class="nx">php</span><span class="o">:</span><span class="mi">1620</span><span class="o">:</span> <span class="k">class</span> <span class="nc">Think\Db\Driver\Mysql</span><span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">8</span> <span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="nv">$PDOStatement</span> <span class="o">=&gt;</span> <span class="k">NULL</span> 
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="nv">$model</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;_think_&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="nv">$queryStr</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="nv">$modelSql</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="nv">$lastInsID</span> <span class="o">=&gt;</span> <span class="k">NULL</span> 
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="nv">$numRows</span> <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="nv">$transTimes</span> <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="nv">$error</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="nv">$linkID</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="nv">$_linkID</span> <span class="o">=&gt;</span> <span class="k">NULL</span> 
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="nv">$config</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="s2">&#34;mysql&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;hostname&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="s2">&#34;127.0.0.1&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;database&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="s2">&#34;web&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;root&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;root123&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;hostport&#39;</span> <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">3306</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;dsn&#39;</span> <span class="o">=&gt;</span> <span class="k">NULL</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;params&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;charset&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;utf8&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;prefix&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;debug&#39;</span> <span class="o">=&gt;</span> <span class="nx">bool</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;deploy&#39;</span> <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;rw_separate&#39;</span> <span class="o">=&gt;</span> <span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;master_num&#39;</span> <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;slave_no&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;db_like_fields&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;lite&#39;</span> <span class="o">=&gt;</span> <span class="k">NULL</span> <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="nv">$exp</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;eq&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="s2">&#34;=&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;neq&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;&lt;&gt;&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;gt&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="s2">&#34;&gt;&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;egt&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;&gt;=&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;lt&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="s2">&#34;&lt;&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;elt&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;&lt;=&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;notlike&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="s2">&#34;NOT LIKE&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;like&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;LIKE&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;in&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;IN&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;notin&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="s2">&#34;NOT IN&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;not in&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="s2">&#34;NOT IN&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;between&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;BETWEEN&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;not between&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="s2">&#34;NOT BETWEEN&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;notbetween&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="s2">&#34;NOT BETWEEN&#34;</span> <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="nv">$selectSql</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">109</span><span class="p">)</span> <span class="s2">&#34;SELECT%DISTINCT% %FIELD% FROM %TABLE%%FORCE%%JOIN%%WHERE%%GROUP%%HAVING%%ORDER%%LIMIT% %UNION%%LOCK%%COMMENT%&#34;</span> <span class="k">protected</span> <span class="nv">$queryTimes</span> <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="nv">$executeTimes</span> <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="nv">$options</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="nx">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="nv">$bind</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>进入_checkTableInfo方法</p>
<h3 id="funtion-_checktableinfo" class="headerLink">
    <a href="#funtion-_checktableinfo" class="header-mark"></a>funtion _checkTableInfo()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 自动检测数据表信息
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access protected
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return void
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="k">function</span> <span class="nf">_checkTableInfo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果不是Model类 自动记录数据表信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 只在第一次执行记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 如果数据表字段没有定义则自动获取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_FIELDS_CACHE&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$db</span>     <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dbName</span> <span class="o">?:</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_NAME&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$fields</span> <span class="o">=</span> <span class="nx">F</span><span class="p">(</span><span class="s1">&#39;_fields/&#39;</span> <span class="o">.</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nv">$db</span> <span class="o">.</span> <span class="s1">&#39;.&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tablePrefix</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nv">$fields</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span> <span class="o">=</span> <span class="nv">$fields</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$fields</span><span class="p">[</span><span class="s1">&#39;_pk&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pk</span> <span class="o">=</span> <span class="nv">$fields</span><span class="p">[</span><span class="s1">&#39;_pk&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">echo</span> <span class="s2">&#34;配置不存在！</span><span class="se">\r\n</span><span class="s2">&#34;</span><span class="p">;</span><span class="c1">//自己加的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 每次都会读取数据表信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_FIELDS_CACHE&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个用来获取数据库字段缓存配置的函数或方法调用。
然后这里直接跳出了判断说明对应的配置值为空
那就紧接着进入到flush方法</p>
<h3 id="function-flush" class="headerLink">
    <a href="#function-flush" class="header-mark"></a>function flush()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 获取字段信息并缓存
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access public
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return void
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 缓存不存在则查询数据表信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">setModel</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">getFields</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getTableName</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$fields</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 无法获取字段信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span> <span class="o">=</span> <span class="nx">array_keys</span><span class="p">(</span><span class="nv">$fields</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="s1">&#39;_pk&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fields</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 记录字段类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$type</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nv">$val</span><span class="p">[</span><span class="s1">&#39;primary&#39;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 增加复合主键支持
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="s1">&#39;_pk&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="k">null</span> <span class="o">!=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="s1">&#39;_pk&#39;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nx">is_string</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="s1">&#39;_pk&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pk</span>            <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="s1">&#39;_pk&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="s1">&#39;_pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pk</span><span class="p">[]</span>            <span class="o">=</span> <span class="nv">$key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="s1">&#39;_pk&#39;</span><span class="p">][]</span> <span class="o">=</span> <span class="nv">$key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pk</span>            <span class="o">=</span> <span class="nv">$key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="s1">&#39;_pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nv">$val</span><span class="p">[</span><span class="s1">&#39;autoinc&#39;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">autoinc</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 记录字段类型信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="s1">&#39;_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2008-3-7 增加缓存开关控制
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_FIELDS_CACHE&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 永久缓存数据表信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$db</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dbName</span> <span class="o">?:</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;DB_NAME&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">F</span><span class="p">(</span><span class="s1">&#39;_fields/&#39;</span> <span class="o">.</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nv">$db</span> <span class="o">.</span> <span class="s1">&#39;.&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tablePrefix</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">),</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑：</p>
<ul>
<li>首先，该方法通过数据库操作对象 $this-&gt;db 获取当前数据表的字段信息。</li>
<li>如果缓存中不存在字段信息，会通过数据库查询获取数据表的字段信息。 如果成功获取到数据表的字段信息，则会对字段进行处理，提取字段名并记录字段类型。同时，如果存在主键字段，则会将主键字段信息记录下来。</li>
<li>根据配置项 C(&lsquo;DB_FIELDS_CACHE&rsquo;) 的值来决定是否开启数据库字段信息的缓存功能。如果配置项为真（即开启状态），则将字段信息以永久缓存的方式存储起来，使用了 F(&rsquo;_fields/&rsquo; . strtolower($db . &lsquo;.&rsquo; . $this-&gt;tablePrefix . $this-&gt;name), $this-&gt;fields) 进行缓存。缓存的键名包含了数据库名称、表前缀和表名等信息，以确保缓存的唯一性和准确性。</li>
</ul>
<p>跟进一下进入setModel方法</p>
<h3 id="function-setmodel" class="headerLink">
    <a href="#function-setmodel" class="header-mark"></a>function setModel()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">setModel</span><span class="p">(</span><span class="nv">$model</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">model</span> <span class="o">=</span> <span class="nv">$model</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>传入的model是</p>
<blockquote>
<p>string(8) &ldquo;Articles&rdquo;</p>
</blockquote>
<p>然后进入getTableName方法</p>
<h3 id="function-gettablename" class="headerLink">
    <a href="#function-gettablename" class="header-mark"></a>function getTableName()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">   <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 得到完整的数据表名
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access public
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return string
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">getTableName</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>    <span class="k">echo</span> <span class="s2">&#34;getTableName方法被调用！</span><span class="se">\r\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">trueTableName</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$tableName</span> <span class="o">=</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tablePrefix</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tablePrefix</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tableName</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$tableName</span> <span class="o">.=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tableName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$tableName</span> <span class="o">.=</span> <span class="nx">parse_name</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">trueTableName</span> <span class="o">=</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nv">$tableName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dbName</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dbName</span> <span class="o">.</span> <span class="s1">&#39;.&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">trueTableName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑</p>
<ul>
<li>当调用该方法时，会先判断是否已经存在缓存的数据表名（<code>$this-&gt;trueTableName</code>）。如果存在，则直接返回缓存的表名，无需重新生成。</li>
<li>如果不存在缓存的表名，会根据以下规则生成数据表名：
<ul>
<li>如果设置了表前缀（$this-&gt;tablePrefix），将其添加到表名中。</li>
<li>如果设置了具体的表名（$this-&gt;tableName），则使用该表名。</li>
<li>如果没有设置具体的表名，则将模型名称（$this-&gt;name）进行转换，然后作为表名。</li>
<li>最后，将生成的表名转换为小写，并存储在 $this-&gt;trueTableName 中缓存起来。</li>
</ul>
</li>
<li>返回格式化后的数据表名。如果设置了数据库名（$this-&gt;dbName），则返回 数据库名.表名 的格式，否则只返回表名。</li>
</ul>
<p><code>$this-&gt;trueTableName</code>为空所以进入到if判断中，因为传入的<code>tablePrefix</code>也为空所以<code>$tableName = &quot;&quot;</code>
这里的判断有点不理解所以就自己写了一个例子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="nv">$a</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$a</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="s2">&#34;TRUE&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="s2">&#34;FALSE&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>a存在的时候为TRUE，不存在（NULL）的时候为FALSE</p>
<p>所以</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">  <span class="nv">$tableName</span> <span class="o">.=</span> <span class="nx">parse_name</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里直接进入<code>parse_name</code>方法(<code>.=</code>表示字符串拼接赋值)</p>
<h3 id="function-parse_name" class="headerLink">
    <a href="#function-parse_name" class="header-mark"></a>function parse_name()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 字符串命名风格转换
</span></span></span><span class="line"><span class="cl"><span class="sd"> * type 0 将Java风格转换为C的风格 1 将C风格转换为Java的风格
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param string $name 字符串
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param integer $type 转换类型
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @return string
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">parse_name</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">ucfirst</span><span class="p">(</span><span class="nx">preg_replace_callback</span><span class="p">(</span><span class="s1">&#39;/_([a-zA-Z])/&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$match</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);},</span> <span class="nv">$name</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nx">trim</span><span class="p">(</span><span class="nx">preg_replace</span><span class="p">(</span><span class="s2">&#34;/[A-Z]/&#34;</span><span class="p">,</span> <span class="s2">&#34;_</span><span class="se">\\</span><span class="s2">0&#34;</span><span class="p">,</span> <span class="nv">$name</span><span class="p">),</span> <span class="s2">&#34;_&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑：</p>
<ul>
<li>当<code>$type</code>为真时，执行驼峰命名到下划线命名的转化：
<ul>
<li>使用正则表达式<code>/_([a-zA-Z])/</code>匹配下划线跟着一个字母的情况。</li>
<li>使用<code>preg_replace_callback()</code>方法进行匹配替换，将下划线后的字符转化为大写形式。</li>
<li>最后，使用<code>unfirst</code>方法将首字母转化为大写。</li>
</ul>
</li>
<li>当<code>$type</code>为假的时候，执行下划线命名到驼峰命名的转化。
<ul>
<li>使用正则表达式<code>/[A-Z]/</code>匹配大写字母的情况。</li>
<li>使用<code>preg_reoplace</code>方法将匹配到的大写字母替换为<code>_</code>加上相同的大写字母</li>
<li>使用<code>trim()</code>方法去除字符串首尾的<code>_</code></li>
<li>最后，使用<code>strtolower</code>方法将字符串转化为小写</li>
</ul>
</li>
</ul>
<p>然后注意到了这里有个匿名函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">function</span> <span class="p">(</span><span class="nv">$match</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>前面使用了<code>preg_replacer_callback()</code>方法，这个匿名函数被用做回调函数</p>
<ul>
<li><code>$match</code>是<code>preg_replacer_callback()</code>方法传递给回调函数的匹配结果数组。在这里，他表示正则表达式匹配到的结果。</li>
<li><code>$match[1]</code>包含了正则表达式中括号内匹配到的内容，即一个小写字母。</li>
<li><code>strtoupper($match[1])</code>将匹配到的小写字母转换为大写字母</li>
</ul>
<p>最后转化完之后为：articles
最后这个方法返回值为：articles</p>
<p>随后进入getfield方法</p>
<h3 id="function-getfield" class="headerLink">
    <a href="#function-getfield" class="header-mark"></a>function getfield()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 取得数据表的字段信息
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access public
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">getFields</span><span class="p">(</span><span class="nv">$tableName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">initConnect</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">list</span><span class="p">(</span><span class="nv">$tableName</span><span class="p">)</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nv">$tableName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$tableName</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">list</span><span class="p">(</span><span class="nv">$dbName</span><span class="p">,</span> <span class="nv">$tableName</span><span class="p">)</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="nv">$tableName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$sql</span>                      <span class="o">=</span> <span class="s1">&#39;SHOW COLUMNS FROM `&#39;</span> <span class="o">.</span> <span class="nv">$dbName</span> <span class="o">.</span> <span class="s1">&#39;`.`&#39;</span> <span class="o">.</span> <span class="nv">$tableName</span> <span class="o">.</span> <span class="s1">&#39;`&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">&#39;SHOW COLUMNS FROM `&#39;</span> <span class="o">.</span> <span class="nv">$tableName</span> <span class="o">.</span> <span class="s1">&#39;`&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$info</span>   <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$result</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">\PDO</span><span class="o">::</span><span class="na">CASE_LOWER</span> <span class="o">!=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_linkID</span><span class="o">-&gt;</span><span class="na">getAttribute</span><span class="p">(</span><span class="nx">\PDO</span><span class="o">::</span><span class="na">ATTR_CASE</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$val</span> <span class="o">=</span> <span class="nx">array_change_key_case</span><span class="p">(</span><span class="nv">$val</span><span class="p">,</span> <span class="nx">CASE_LOWER</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$info</span><span class="p">[</span><span class="nv">$val</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;name&#39;</span>    <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;type&#39;</span>    <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;notnull&#39;</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="o">===</span> <span class="nv">$val</span><span class="p">[</span><span class="s1">&#39;null&#39;</span><span class="p">]),</span> <span class="c1">// not null is empty, null is yes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="s1">&#39;default&#39;</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;primary&#39;</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">strtolower</span><span class="p">(</span><span class="nv">$val</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;pri&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;autoinc&#39;</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">strtolower</span><span class="p">(</span><span class="nv">$val</span><span class="p">[</span><span class="s1">&#39;extra&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;auto_increment&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑：</p>
<ul>
<li>初始化数据库连接。</li>
<li>解析传入的 $tableName 参数，以便准备构建 SQL 查询语句。如果 $tableName 包含了数据库名称和数据表名称，则将其分离出来，以便构建查询语句。如果没有数据库名称，则默认在当前数据库中查询。</li>
<li>根据构建好的 SQL 查询语句，执行 SHOW COLUMNS FROM 查询获取表的字段信息。</li>
<li>对查询结果进行处理，遍历结果集并将每个字段的相关信息存储在数组 $info 中：
<ul>
<li>字段名作为数组的键；</li>
<li>字段的相关信息（如类型、是否为主键、是否自增等）作为数组的值。</li>
</ul>
</li>
<li>返回存储字段信息的数组 $info。</li>
</ul>
<p>根据上面的传参可以知道这里进入getfield方法的参数为：“articles‘，然后进行初始化数据库连接（即进入initConnect方法）</p>
<h3 id="function-initconnect" class="headerLink">
    <a href="#function-initconnect" class="header-mark"></a>function initConnect()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 初始化数据库连接
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access protected
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param boolean $master 主服务器
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return void
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="k">function</span> <span class="nf">initConnect</span><span class="p">(</span><span class="nv">$master</span> <span class="o">=</span> <span class="k">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="p">[</span><span class="s1">&#39;deploy&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 采用分布式数据库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_linkID</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">multiConnect</span><span class="p">(</span><span class="nv">$master</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 默认单数据库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_linkID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_linkID</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>首先，检查配置中是否启用了数据库的分布式部署</li>
<li>如果分配了分布式数据库，则用<code>multiConnect</code>方法来建立数据库的连接</li>
<li>如果为设置分布式数据库，或者分布式数据库连接为<code>false</code>，则通过<code>connect</code>方法建立单个数据库连接
这里通过给的文件可以看出来，肯定是属于单数据库的，所以我们跟进到connect方法进行初始化</li>
</ul>
<h3 id="function-connect" class="headerLink">
    <a href="#function-connect" class="header-mark"></a>function connect()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 连接数据库方法
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access public
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">connect</span><span class="p">(</span><span class="nv">$config</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$linkNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$autoConnection</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">linkID</span><span class="p">[</span><span class="nv">$linkNum</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$config</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$config</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;dsn&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;dsn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseDsn</span><span class="p">(</span><span class="nv">$config</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">version_compare</span><span class="p">(</span><span class="k">PHP_VERSION</span><span class="p">,</span> <span class="s1">&#39;5.3.6&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 禁用模拟预处理语句
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">[</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_EMULATE_PREPARES</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">linkID</span><span class="p">[</span><span class="nv">$linkNum</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;dsn&#39;</span><span class="p">],</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\PDOException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nv">$autoConnection</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">trace</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(),</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;ERR&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="nv">$autoConnection</span><span class="p">,</span> <span class="nv">$linkNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">E</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">linkID</span><span class="p">[</span><span class="nv">$linkNum</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>因为前面的调用的时候并没有传参，所以这里三个参数的默认值不变</li>
<li>首先判断之前指定的连接编号的数据库有无建立连接，若无，则创建新的连接</li>
<li>先获取了配置信息<code>$config</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="s2">&#34;mysql&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;hostname&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="s2">&#34;127.0.0.1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;database&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="s2">&#34;web&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;root&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;root123&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;hostport&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">int</span><span class="p">(</span><span class="mi">3306</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;dsn&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">NULL</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;params&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="nx">·</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;charset&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;utf8&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;prefix&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;debug&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">bool</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;deploy&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;rw_separate&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;master_num&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;slave_no&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;db_like_fields&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;lite&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">NULL</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>进入到获取DSN中，这里我就直接把获取的配置dump出来了，就不进去进行分析了</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">54</span><span class="p">)</span> <span class="s2">&#34;mysql:dbname=web;host=127.0.0.1;port=3306;charset=utf8&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>这里的判断version也是没有过去，所以就跳到下面的<code>new PDO</code>了</li>
<li>在连接过程中，捕获可能出现的<code>PDOException</code>异常，如果异常被捕获到，根据情况做以下处理
<ul>
<li>如果启动了自动连接<code>$autoconnection</code>为真，则记录异常信息并尝试重新连接数据库</li>
<li>如果没有启动自动连接，并且配置中的调试模式开启，则抛出异常信息</li>
</ul>
</li>
<li>最后返回建立的数据库连接对象<code>$this-&gt;linkID[$linkNum]</code>，或者在异常的时候抛出false</li>
</ul>
<p>建立连接后我们继续跟进getfield方法
这里的<code>$tableName</code>没有<code>.</code>号所以这里直接跳到else，然后定义了sql语句</p>
<blockquote>
<p>$sql = &lsquo;SHOW COLUMNS FROM <code>' . $tableName . '</code>&rsquo;;</p>
</blockquote>
<p>跟进query方法</p>
<h3 id="function-query" class="headerLink">
    <a href="#function-query" class="header-mark"></a>function query()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 执行查询 返回数据集
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access public
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param string $str  sql指令
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param boolean $fetchSql  不执行只是获取SQL
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">query</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$fetchSql</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">initConnect</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_linkID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">queryStr</span> <span class="o">=</span> <span class="nv">$str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bind</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$that</span>           <span class="o">=</span> <span class="nv">$this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">queryStr</span> <span class="o">=</span> <span class="nx">strtr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">queryStr</span><span class="p">,</span> <span class="nx">array_map</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$val</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$that</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="s1">&#39;\&#39;&#39;</span> <span class="o">.</span> <span class="nv">$that</span><span class="o">-&gt;</span><span class="na">escapeString</span><span class="p">(</span><span class="nv">$val</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;\&#39;&#39;</span><span class="p">;},</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bind</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$fetchSql</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">queryStr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//释放前次的查询结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">PDOStatement</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">free</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">queryTimes</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">N</span><span class="p">(</span><span class="s1">&#39;db_query&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// 兼容代码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 调试开始
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">debug</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">PDOStatement</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_linkID</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">PDOStatement</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bind</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$val</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">PDOStatement</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">$val</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">PDOStatement</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bind</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">PDOStatement</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 调试结束
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">debug</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\PDOException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>这里再次调用了一次initconnect方法进行初始化数据库，所以后面的逻辑不在说明</li>
<li><code>$this-&gt;queryStr = $str;</code>这里将查询语句赋值给queryStr属性</li>
<li>这里跟进代码后直接跳过了两个if判断也就是说明<code>$fetchSql</code>and <code>PDOStatement</code>都不存在或者为null（也就是说明上次查询的结果为空，Fetchsql默认为false所以这里直接过了）</li>
<li>queryTimes++也就是查询次数+1</li>
<li>进入N方法</li>
</ul>
<h3 id="function-n" class="headerLink">
    <a href="#function-n" class="header-mark"></a>function N()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="sd">/**  
</span></span></span><span class="line"><span class="cl"><span class="sd">* 设置和获取统计数据  
</span></span></span><span class="line"><span class="cl"><span class="sd">* 使用方法:  
</span></span></span><span class="line"><span class="cl"><span class="sd">* &lt;code&gt;  
</span></span></span><span class="line"><span class="cl"><span class="sd">* N(&#39;db&#39;,1); // 记录数据库操作次数  
</span></span></span><span class="line"><span class="cl"><span class="sd">* N(&#39;read&#39;,1); // 记录读取次数  
</span></span></span><span class="line"><span class="cl"><span class="sd">* echo N(&#39;db&#39;); // 获取当前页面数据库的所有操作次数  
</span></span></span><span class="line"><span class="cl"><span class="sd">* echo N(&#39;read&#39;); // 获取当前页面读取次数  
</span></span></span><span class="line"><span class="cl"><span class="sd">* &lt;/code&gt;  
</span></span></span><span class="line"><span class="cl"><span class="sd">* @param string $key 标识位置  
</span></span></span><span class="line"><span class="cl"><span class="sd">* @param integer $step 步进值  
</span></span></span><span class="line"><span class="cl"><span class="sd">* @param boolean $save 是否保存结果  
</span></span></span><span class="line"><span class="cl"><span class="sd">* @return mixed  
</span></span></span><span class="line"><span class="cl"><span class="sd">*/</span>  
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">N</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$save</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span> <span class="k">echo</span> <span class="s2">&#34;N方法被调用！！！</span><span class="se">\r\n</span><span class="s2">&#34;</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="nv">$_num</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_num</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="nv">$_num</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">false</span> <span class="o">!==</span> <span class="nv">$save</span><span class="p">)</span> <span class="o">?</span> <span class="nx">S</span><span class="p">(</span><span class="s1">&#39;N_&#39;</span> <span class="o">.</span> <span class="nv">$key</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$step</span><span class="p">))</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="nv">$_num</span><span class="p">[</span><span class="nv">$key</span><span class="p">];</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="nv">$_num</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_num</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$step</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">!==</span> <span class="nv">$save</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// 保存结果  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">S</span><span class="p">(</span><span class="s1">&#39;N_&#39;</span> <span class="o">.</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$_num</span><span class="p">[</span><span class="nv">$key</span><span class="p">],</span> <span class="nv">$save</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="k">null</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>先定义了一个数组<code>$_num</code>（guess是用来保存计数器类的东西）</li>
<li>dump了一下<code>$_num[$key]</code>的值，为NULL所以可以进入到下面的三元运算符</li>
<li><code>$save</code>默认为false所以这里最后的值为0</li>
<li>然后调用的时候传入的参数<code>$step=1</code>所以进入else
<ul>
<li>将<code>$_num[$key]</code>的值改为step的值</li>
</ul>
</li>
<li>最后没有保存结果返回了null
继续回到query方法</li>
<li>进入debug方法</li>
</ul>
<h3 id="function-debug" class="headerLink">
    <a href="#function-debug" class="header-mark"></a>function debug()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="sd">/**  
</span></span></span><span class="line"><span class="cl"><span class="sd">* 数据库调试 记录当前SQL  
</span></span></span><span class="line"><span class="cl"><span class="sd">* @access protected  
</span></span></span><span class="line"><span class="cl"><span class="sd">* @param boolean $start 调试开始标记 true 开始 false 结束  
</span></span></span><span class="line"><span class="cl"><span class="sd">*/</span>  
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="k">function</span> <span class="nf">debug</span><span class="p">(</span><span class="nv">$start</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">])</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// 开启数据库调试模式  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nv">$start</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="nx">G</span><span class="p">(</span><span class="s1">&#39;queryStartTime&#39;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">modelSql</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">model</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">queryStr</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="c1">//$this-&gt;model = &#39;_think_&#39;;  
</span></span></span><span class="line"><span class="cl"><span class="c1">// 记录操作结束时间  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">G</span><span class="p">(</span><span class="s1">&#39;queryEndTime&#39;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="nx">trace</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">queryStr</span> <span class="o">.</span> <span class="s1">&#39; [ RunTime:&#39;</span> <span class="o">.</span> <span class="nx">G</span><span class="p">(</span><span class="s1">&#39;queryStartTime&#39;</span><span class="p">,</span> <span class="s1">&#39;queryEndTime&#39;</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;s ]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;SQL&#39;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>传参<code>$start = true</code></li>
<li>这里G的调用前面分析过了就是用来记录和统计时间和内存使用情况的</li>
<li>最后就跳出debug</li>
</ul>
<p>回到query()    <del>没绷住这里来回跳跃.jpg</del></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">PDOStatement</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_linkID</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>利用<code>PDO::prepare</code>方法准备查询语句，将绑定的参数<code>$sql</code>绑定到查询中。
同样的我dump出来：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PDOStatement</span><span class="c1">#10 (1) {|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">public</span> <span class="nv">$queryString</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">57</span><span class="p">)</span> <span class="s2">&#34;SELECT `content` FROM `articles` WHERE `id` = 1 LIMIT 1 &#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里把查询语句搬出来一下：
#select <strong>SELECT <code>content</code> FROM <code>articles</code> WHERE <code>id</code> = 1 LIMIT 1</strong>
so，这个地方的<code>$this-&gt;PDOStatement</code>不为false，直接走下去</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bind</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$val</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">PDOStatement</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">$val</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">PDOStatement</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这段debug的时候直接跳了就不分析了</p>
<ul>
<li>重新给<code>$this-&gt;bind</code>赋值为0</li>
<li>关闭了debug（可能是不在需要记录调试信息）</li>
<li><code>$result = 1</code> -&gt; <code>return $this-&gt;getResult()</code></li>
</ul>
<h3 id="function-getresult" class="headerLink">
    <a href="#function-getresult" class="header-mark"></a>function getResult()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 获得所有的查询数据
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access private
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return array
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">function</span> <span class="nf">getResult</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//返回数据集
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$result</span>        <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">PDOStatement</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">numRows</span> <span class="o">=</span> <span class="nx">count</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>$this-&gt;PDOStatement-&gt;fetchAll(PDO::FETCH_ASSOC);</code>
<ul>
<li><code>fetchALL</code>是PDOStatement对象的方法，用于从数据库中获取查询的结构集</li>
<li><code>PDO::FETCH_ASSOC</code>是一个常量，表示返回的结果以关联数组的形式进行返回，其中键名是列名。</li>
</ul>
</li>
<li><code>$this-&gt;numRows = count($result);</code></li>
<li>查询结果中的行数存储在<code>$this-&gt;numRows</code>这个类属性中。</li>
</ul>
<p>这里最后就返回了结果，也就是我们现在回到<code>getFields</code>方法继续进行分析
然后这里我就把返回的结果dump一下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;id&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;int(11)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;null&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;NO&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;key&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="s2">&#34;PRI&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;default&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">NULL</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;extra&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="s2">&#34;auto_increment&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;content&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;text&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;null&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="s2">&#34;YES&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;key&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;default&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">NULL</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;extra&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="s2">&#34;title&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;text&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;null&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="s2">&#34;YES&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;key&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;default&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">NULL</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;extra&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>先定义个空的数组<code>$info</code>用来存储数据</li>
<li>利用遍历循环，遍历了数据库查询返回的结果集<code>$result</code>。每个<code>$var</code>变量代表一个记录，存储了字段的信息。</li>
<li><code>if (\PDO::CASE_LOWER != $this-&gt;_linkID-&gt;getAttribute(\PDO::ATTR_CASE))</code>
<ul>
<li><code>\PDO::CASE_LOWER</code>是PDO类的一个常量，表示键名转化为小写。</li>
<li><code>PDO：：ATTR_CASE</code>用于获取键名大小写转化的模式</li>
</ul>
</li>
<li>所以这个逻辑就是：首先检查当前数据库连接的属性，确定数据库是否对键名大小写敏感，如果对键名大小写不敏感则转化为小写（即最后保存在数组中的数据都是小写）</li>
</ul>
<p>dump一下info</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;id&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;int(11)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;notnull&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;default&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">NULL</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;primary&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">bool</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;autoinc&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">bool</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;content&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;content&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;text&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;notnull&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;default&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">NULL</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;primary&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;autoinc&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="s2">&#34;title&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;text&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;notnull&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;default&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">NULL</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;primary&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;autoinc&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>那么到这里就返回了内容后回到flush方法继续跟进</p>
<ul>
<li>传回info之后赋值给<code>fields</code></li>
<li>调用<code>$this→field</code>赋值为fileld的name值</li>
<li>dump：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">string</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;id&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;content&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="s2">&#34;title&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>利用unset销毁<code>$this→fields[’_pk’]</code>（这里应该是局部变量）</p>
</li>
<li>
<p>循环遍历数据库查询结果中的字段信息。</p>
</li>
<li>
<p>将字段类型记录到 <strong><code>$type</code></strong> 数组中，以字段名为键名。</p>
<ul>
<li>dump值：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;int(11)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;text&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;text&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>判断当前是否是主键字段</p>
<ul>
<li>如果已经存在主键字段（<strong><code>$this-&gt;fields['_pk']</code></strong>），并且不为空，则表示当前表是复合主键。</li>
<li>如果主键是字符串类型，将其转换为数组形式，并重新赋值给 <strong><code>$_pk</code></strong>。</li>
<li>将当前字段名追加到主键数组中，并更新 <strong><code>_pk</code></strong> 字段信息。</li>
</ul>
</li>
<li>
<p>如果不存在主键字段，则将当前字段名作为主键字段。</p>
</li>
<li>
<p>如果当前字段具有自动增长属性（<strong><code>$val['autoinc']</code></strong> 为真），将 <strong><code>$this-&gt;autoinc</code></strong> 设置为真，表示主键是自动增长的。</p>
</li>
<li>
<p>这里debug了一下发现只有一个主键，所以后面两个值不是主键。并且第一个不是复合主键</p>
</li>
<li>
<p>在循环之后记录字段类型信息，dump(其实也就是前面循环遍历处理来的值)</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;int(11)&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;content&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;text&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;text&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>通过C方法判断数据库字段缓存是否开启，若开启则永久保存数据表信息（debug直接跳过了所以没有开启）</li>
</ul>
<p>然后这里就把这些参数一一传回去，然后到这里为止M方法走完了，接下来就进入了<code>field</code>方法field(&lsquo;content&rsquo;)</p>
<h3 id="function-field" class="headerLink">
    <a href="#function-field" class="header-mark"></a>function field()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 指定查询字段 支持字段排除
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access public
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param mixed $field
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param boolean $except 是否排除
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return Model
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">field</span><span class="p">(</span><span class="nv">$field</span><span class="p">,</span> <span class="nv">$except</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>   <span class="k">echo</span> <span class="s2">&#34;field函数被调用！！</span><span class="se">\r\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">true</span> <span class="o">===</span> <span class="nv">$field</span><span class="p">){</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 获取全部字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDbFields</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$field</span>  <span class="o">=</span> <span class="nv">$fields</span> <span class="o">?:</span> <span class="s1">&#39;*&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$except</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 字段排除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="nx">is_string</span><span class="p">(</span><span class="nv">$field</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$field</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nv">$field</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDbFields</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$field</span>  <span class="o">=</span> <span class="nv">$fields</span> <span class="o">?</span> <span class="nx">array_diff</span><span class="p">(</span><span class="nv">$fields</span><span class="p">,</span> <span class="nv">$field</span><span class="p">)</span> <span class="o">:</span> <span class="nv">$field</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$field</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>因为传入的<code>field</code>值不是bool值并且<code>$except = false</code>所以直接到最后面两个语句</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$field</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后return的结果是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Think\Model</span><span class="c1">#7 (21) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">protected</span> <span class="nv">$db</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="k">class</span> <span class="nc">Think\Db\Driver\Mysql</span><span class="c1">#8 (17) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">protected</span> <span class="nv">$PDOStatement</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">PDOStatement</span><span class="c1">#10 (1) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">public</span> <span class="nv">$queryString</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span> <span class="s2">&#34;SHOW COLUMNS FROM `articles`&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$model</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="s2">&#34;Articles&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$queryStr</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span> <span class="s2">&#34;SHOW COLUMNS FROM `articles`&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$modelSql</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;Articles&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span> <span class="s2">&#34;SHOW COLUMNS FROM `articles`&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$lastInsID</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">NULL</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$numRows</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">int</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$transTimes</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$error</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$linkID</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="k">class</span> <span class="nc">PDO</span><span class="c1">#9 (0) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">...</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$_linkID</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">PDO</span><span class="c1">#9 (0) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$config</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">array</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="s2">&#34;mysql&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;hostname&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="s2">&#34;127.0.0.1&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;database&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="s2">&#34;web&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;root&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;root123&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;hostport&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">int</span><span class="p">(</span><span class="mi">3306</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;dsn&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="k">NULL</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;params&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;charset&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;utf8&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;prefix&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;debug&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">bool</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;deploy&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;rw_separate&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;master_num&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;slave_no&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;db_like_fields&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;lite&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="k">NULL</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$exp</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">array</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;eq&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="s2">&#34;=&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;neq&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;&lt;&gt;&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;gt&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="s2">&#34;&gt;&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;egt&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;&gt;=&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;lt&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="s2">&#34;&lt;&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;elt&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;&lt;=&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;notlike&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="s2">&#34;NOT LIKE&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;like&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;LIKE&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;in&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;IN&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;notin&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="s2">&#34;NOT IN&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;not in&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="s2">&#34;NOT IN&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;between&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;BETWEEN&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;not between&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="s2">&#34;NOT BETWEEN&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;notbetween&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="s2">&#34;NOT BETWEEN&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$selectSql</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">109</span><span class="p">)</span> <span class="s2">&#34;SELECT%DISTINCT% %FIELD% FROM %TABLE%%FORCE%%JOIN%%WHERE%%GROUP%%HAVING%%ORDER%%LIMIT% %UNION%%LOCK%%COMMENT%&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$queryTimes</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$executeTimes</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$options</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">array</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">int</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">int</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span><span class="mi">1002</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="s2">&#34;SET NAMES utf8&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$bind</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">private</span> <span class="nv">$_db</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Think\Db\Driver\Mysql</span><span class="c1">#8 (17) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">protected</span> <span class="nv">$PDOStatement</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="k">class</span> <span class="nc">PDOStatement</span><span class="c1">#10 (1) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">...</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$model</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="s2">&#34;Articles&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$queryStr</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span> <span class="s2">&#34;SHOW COLUMNS FROM `articles`&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$modelSql</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$lastInsID</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="k">NULL</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$numRows</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">int</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$transTimes</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$error</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$linkID</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$_linkID</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="k">class</span> <span class="nc">PDO</span><span class="c1">#9 (0) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">...</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$config</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="k">array</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$exp</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="k">array</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$selectSql</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">109</span><span class="p">)</span> <span class="s2">&#34;SELECT%DISTINCT% %FIELD% FROM %TABLE%%FORCE%%JOIN%%WHERE%%GROUP%%HAVING%%ORDER%%LIMIT% %UNION%%LOCK%%COMMENT%&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$queryTimes</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$executeTimes</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$options</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="k">array</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$bind</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$pk</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">string</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;id&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$autoinc</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bool</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$tablePrefix</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$name</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">string</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="s2">&#34;Articles&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$dbName</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$connection</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$tableName</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$trueTableName</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">string</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="s2">&#34;articles&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$error</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$fields</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="k">array</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;id&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;content&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="s2">&#34;title&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;_pk&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;id&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;_type&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">array</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;int(11)&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;content&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;text&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;text&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$data</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$options</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;content&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$_validate</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$_auto</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$_map</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$_scope</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$autoCheckFields</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bool</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$patchValidate</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bool</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span> <span class="nv">$methods</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="k">array</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="s2">&#34;strict&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="s2">&#34;order&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="s2">&#34;alias&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="s2">&#34;having&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="s2">&#34;group&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;lock&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="s2">&#34;distinct&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;auto&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="s2">&#34;filter&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="s2">&#34;validate&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="s2">&#34;result&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="s2">&#34;token&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="s2">&#34;index&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="s2">&#34;force&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>之后就到find函数了（这里就有可控参数<code>$cid</code>了）</p>
<h3 id="function-find" class="headerLink">
    <a href="#function-find" class="header-mark"></a>function find()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 查询数据
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access public
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param mixed $options 表达式参数
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">is_numeric</span><span class="p">(</span><span class="nv">$options</span><span class="p">)</span> <span class="o">||</span> <span class="nx">is_string</span><span class="p">(</span><span class="nv">$options</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$where</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getPk</span><span class="p">()]</span> <span class="o">=</span> <span class="nv">$options</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$options</span>               <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;where&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="nv">$where</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 根据复合主键查找记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$pk</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getPk</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$options</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">count</span><span class="p">(</span><span class="nv">$options</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">is_array</span><span class="p">(</span><span class="nv">$pk</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 根据复合主键查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">foreach</span> <span class="p">(</span><span class="nx">array_keys</span><span class="p">(</span><span class="nv">$options</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">is_int</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$count</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">count</span><span class="p">(</span><span class="nv">$pk</span><span class="p">)</span> <span class="o">==</span> <span class="nv">$count</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$pk</span> <span class="k">as</span> <span class="nv">$field</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$where</span><span class="p">[</span><span class="nv">$field</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$options</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">unset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="nv">$i</span><span class="o">++</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;where&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$where</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 总是查找一条记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 分析表达式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$options</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_parseOptions</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 判断查询缓存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;cache&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$cache</span> <span class="o">=</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;cache&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$key</span>   <span class="o">=</span> <span class="nx">is_string</span><span class="p">(</span><span class="nv">$cache</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$cache</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">serialize</span><span class="p">(</span><span class="nv">$options</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$data</span>  <span class="o">=</span> <span class="nx">S</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$cache</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">!==</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resultSet</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nv">$resultSet</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$resultSet</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 查询结果为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">is_string</span><span class="p">(</span><span class="nv">$resultSet</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nv">$resultSet</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 读取数据后的处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_read_data</span><span class="p">(</span><span class="nv">$resultSet</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_after_find</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">returnResult</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$cache</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">S</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$cache</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>首先通过<code>is_numeric()</code>和<code>is_string()</code>函数对参数<code>$option</code>进行检查。如果传入的参数是数字或者字符类型，就会假设这是要根据主键进行查询</li>
<li>如果传入的参数是数字或字符串类型，他会创建一个<code>$where</code>数组，并用主键作为键，传入的参数为值，然后这个<code>$where</code>数组放入<code>$options['where']</code>中</li>
<li>如果传入的参数是数组类型，他会尝试判断是否可以构建复合主键查询的条件</li>
<li>但是最后都只会返回一条记录（$options[&rsquo;limit&rsquo;] = 1;）
然后跟进一下这个方法（注释是说分析表达式）</li>
</ul>
<h3 id="function-_parseoptions" class="headerLink">
    <a href="#function-_parseoptions" class="header-mark"></a>function _parseOptions</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 分析表达式
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access protected
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param array $options 表达式参数
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return array
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="k">function</span> <span class="nf">_parseOptions</span><span class="p">(</span><span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$options</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$options</span> <span class="o">=</span> <span class="nx">array_merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 自动获取表名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getTableName</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$fields</span>           <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 指定数据表 则重新获取字段列表 但不支持类型检测
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDbFields</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 数据表别名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]</span> <span class="o">.=</span> <span class="s1">&#39; &#39;</span> <span class="o">.</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 记录操作的模型名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 字段类型验证
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;where&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">is_array</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;where&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$fields</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;join&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 对数组查询条件进行字段类型检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;where&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$key</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$fields</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nx">is_scalar</span><span class="p">(</span><span class="nv">$val</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_parseType</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;where&#39;</span><span class="p">],</span> <span class="nv">$key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="nx">is_numeric</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;_&#39;</span> <span class="o">!=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">false</span> <span class="o">===</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">false</span> <span class="o">===</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">false</span> <span class="o">===</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">false</span> <span class="o">===</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">[</span><span class="s1">&#39;strict&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">E</span><span class="p">(</span><span class="nx">L</span><span class="p">(</span><span class="s1">&#39;_ERROR_QUERY_EXPRESS_&#39;</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;:[&#39;</span> <span class="o">.</span> <span class="nv">$key</span> <span class="o">.</span> <span class="s1">&#39;=&gt;&#39;</span> <span class="o">.</span> <span class="nv">$val</span> <span class="o">.</span> <span class="s1">&#39;]&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">unset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;where&#39;</span><span class="p">][</span><span class="nv">$key</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 查询过后清空sql表达式组装 避免影响下次查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 表达式过滤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_options_filter</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$options</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="sb">```
</span></span></span><span class="line"><span class="cl"><span class="sb">- 根据上面传递进来的值，dump出来看一下传入了哪些东西
</span></span></span><span class="line"><span class="cl"><span class="sb">```</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;where&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="s2">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;limit&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>当前对象的<code>options</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;content&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来来分析逻辑</p>
<ul>
<li>判断传入的<code>$options</code>是否是数组（当然这里直接看就知道是数组），使用<code>arrat_merge</code>讲当前对象的<code>options</code>和传入的<code>options</code>进行合并</li>
<li>当前没有传入表名，所以会自动通过<code>getTableName()</code>方法进行自动获取表名，这个方法上面已经分析过了，这里就不再次分析了</li>
<li>判断[&lsquo;alias&rsquo;]这个键值是否存在（也就是数据库别名） 就会将表名与别名结合起来进行查询（当然通过前面的dump可以看出来是没有别名的）</li>
<li>记录当前操作模型的名称传入<code>model</code>的值(<code>Articles</code>)</li>
<li>判断<code>[where]</code>是否存在且是否为数组；<code>[$field]</code>存在且<code>[join]</code>不存在，则对数组查询条件进行字段类型检查</li>
<li>首先遍历<code>where</code>的值，先利用trim进行去除空格，判断<code>$key</code>是否存在于<code>$fields</code>之中（下面dump出来好分析），</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;id&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;content&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="s2">&#34;title&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;_pk&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;id&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;_type&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;int(11)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;content&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;text&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;text&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>判断键名的值是否是标量（标量变量是包含int、 float、string或bool的变量。类型array、object、resources 和null不是标量。）很明显是的</li>
<li>进入_praseTyoe方法</li>
</ul>
<h3 id="function-_parsetype" class="headerLink">
    <a href="#function-_parsetype" class="header-mark"></a>function _parseType</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 数据类型检测
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access protected
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param mixed $data 数据
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param string $key 字段名
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return void
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="k">function</span> <span class="nf">_parseType</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">[</span><span class="s1">&#39;bind&#39;</span><span class="p">][</span><span class="s1">&#39;:&#39;</span> <span class="o">.</span> <span class="nv">$key</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="s1">&#39;_type&#39;</span><span class="p">][</span><span class="nv">$key</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$fieldType</span> <span class="o">=</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="s1">&#39;_type&#39;</span><span class="p">][</span><span class="nv">$key</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">!==</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$fieldType</span><span class="p">,</span> <span class="s1">&#39;enum&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 支持ENUM类型优先检测
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$fieldType</span><span class="p">,</span> <span class="s1">&#39;bigint&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">false</span> <span class="o">!==</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$fieldType</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$data</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">intval</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="nv">$key</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="k">false</span> <span class="o">!==</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$fieldType</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="k">false</span> <span class="o">!==</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$fieldType</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$data</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">floatval</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="nv">$key</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="k">false</span> <span class="o">!==</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$fieldType</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$data</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$key</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>where</code>的键值传入了<code>$data</code>(注意这里直接传的是地址&amp;),键名<code>key</code>传入<code>$key</code>，很明显这里第一个if语句是成立的，我们直接看下面做了什么操作就行了</li>
<li>判断是什么类型(ENUM、INT、BOOL、DOUBLE、FLOAT)这里的枚举类型具有优先级，但是没有进行什么操作，int类型将值转化为整数，float和double转化为浮点数，bool类型还是转化为布尔型。</li>
<li>其实就是为了确保数据可以以正确形式写入数据库进行查询
回到_parseOptions方法</li>
<li>查询完之后又将当前对象的<code>options</code>进行清空</li>
<li>后面的filter没有进行什么操作就不分析了，最后返回<code>$options</code>
转化后的options</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> 
</span></span><span class="line"><span class="cl"> <span class="nx">string</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="s2">&#34;content&#34;</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;where&#39;</span> <span class="o">=&gt;</span> 
</span></span><span class="line"><span class="cl"> <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> 
</span></span><span class="line"><span class="cl"> <span class="nx">int</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"> <span class="p">}</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;limit&#39;</span> <span class="o">=&gt;</span> 
</span></span><span class="line"><span class="cl"> <span class="nx">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;table&#39;</span> <span class="o">=&gt;</span> 
</span></span><span class="line"><span class="cl"> <span class="nx">string</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="s2">&#34;articles&#34;</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;model&#39;</span> <span class="o">=&gt;</span> 
</span></span><span class="line"><span class="cl"> <span class="nx">string</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="s2">&#34;Articles&#34;</span> 
</span></span><span class="line"><span class="cl"> <span class="p">}</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以和前面原来的options对比一下看看是不是跟着逻辑走的
这里返回后回到<code>find</code>方法</p>
<ul>
<li>判断查询缓存是否存在，跟进后发现直接跳出去了，说明是不存在的也就是cache这个缓存不存在</li>
<li>接下来利用<code>select</code>方法进行查询返回给<code>$resultSet</code></li>
</ul>
<h3 id="function-select" class="headerLink">
    <a href="#function-select" class="header-mark"></a>function select()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 查找记录
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access public
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param array $options 表达式
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">select</span><span class="p">(</span><span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">model</span> <span class="o">=</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseBind</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;bind&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;bind&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">array</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$sql</span>    <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">buildSelectSql</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;fetch_sql&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="k">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>同样的还是将<code>$options</code>设置成空数组（当前对象中），设置当前模型名称，进入<code>parseBind</code>方法,进行参数绑定</li>
</ul>
<h3 id="function-parsebind" class="headerLink">
    <a href="#function-parsebind" class="header-mark"></a>function parseBind</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 参数绑定分析
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access protected
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param array $bind
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return array
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="k">function</span> <span class="nf">parseBind</span><span class="p">(</span><span class="nv">$bind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bind</span> <span class="o">=</span> <span class="nx">array_merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bind</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>接下来调用<code>buildselectsql</code> 方法,生成查询sql语句</li>
</ul>
<h3 id="function-buildselectsql" class="headerLink">
    <a href="#function-buildselectsql" class="header-mark"></a>function buildSelectSql()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 生成查询SQL
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access public
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param array $options 表达式
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return string
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">buildSelectSql</span><span class="p">(</span><span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 根据页数计算limit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">list</span><span class="p">(</span><span class="nv">$page</span><span class="p">,</span> <span class="nv">$listRows</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$page</span>                  <span class="o">=</span> <span class="nv">$page</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nv">$page</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$listRows</span>              <span class="o">=</span> <span class="nv">$listRows</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nv">$listRows</span> <span class="o">:</span> <span class="p">(</span><span class="nx">is_numeric</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;limit&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;limit&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$offset</span>                <span class="o">=</span> <span class="nv">$listRows</span> <span class="o">*</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;limit&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="nv">$offset</span> <span class="o">.</span> <span class="s1">&#39;,&#39;</span> <span class="o">.</span> <span class="nv">$listRows</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$sql</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseSql</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">selectSql</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$sql</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>如果<code>$options</code>中包含page键，表示需要进行分页查询，提取出页数和每页的行数，根据他们计算出<code>limit</code>字句，将其添加到$optionsp[&rsquo;limit&rsquo;]中，如果未设置每页行数，默认使用20</li>
</ul>
<h3 id="function-parsesql" class="headerLink">
    <a href="#function-parsesql" class="header-mark"></a>function parseSql()</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 替换SQL语句中表达式
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access public
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param array $options 表达式
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return string
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">parseSql</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$sql</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;%TABLE%&#39;</span><span class="p">,</span> <span class="s1">&#39;%DISTINCT%&#39;</span><span class="p">,</span> <span class="s1">&#39;%FIELD%&#39;</span><span class="p">,</span> <span class="s1">&#39;%JOIN%&#39;</span><span class="p">,</span> <span class="s1">&#39;%WHERE%&#39;</span><span class="p">,</span> <span class="s1">&#39;%GROUP%&#39;</span><span class="p">,</span> <span class="s1">&#39;%HAVING%&#39;</span><span class="p">,</span> <span class="s1">&#39;%ORDER%&#39;</span><span class="p">,</span> <span class="s1">&#39;%LIMIT%&#39;</span><span class="p">,</span> <span class="s1">&#39;%UNION%&#39;</span><span class="p">,</span> <span class="s1">&#39;%LOCK%&#39;</span><span class="p">,</span> <span class="s1">&#39;%COMMENT%&#39;</span><span class="p">,</span> <span class="s1">&#39;%FORCE%&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseTable</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseDistinct</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;distinct&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;distinct&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">false</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseField</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;*&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseJoin</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;join&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;join&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseWhere</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;where&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;where&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseGroup</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseHaving</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;having&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;having&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseOrder</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseLimit</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;limit&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;limit&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseUnion</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;union&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;union&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseLock</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;lock&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;lock&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">false</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseComment</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseForce</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;force&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;force&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span> <span class="nv">$sql</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$sql</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>这个方法用于解析sql查询语句中的各种选项</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">替换</span> <span class="o">%</span><span class="nx">TABLE</span><span class="o">%</span><span class="nx">：</span>  
</span></span><span class="line"><span class="cl"><span class="nx">调用</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseTable</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">])</span> <span class="nx">方法，解析数据表名。</span>  
</span></span><span class="line"><span class="cl"><span class="nx">替换</span> <span class="o">%</span><span class="nx">DISTINCT</span><span class="o">%</span><span class="nx">：</span>  
</span></span><span class="line"><span class="cl"><span class="nx">调用</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseDistinct</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;distinct&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;distinct&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">false</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nx">方法，解析是否需要</span> <span class="nx">DISTINCT。</span>  
</span></span><span class="line"><span class="cl"><span class="nx">替换</span> <span class="o">%</span><span class="nx">FIELD</span><span class="o">%</span><span class="nx">：</span>  
</span></span><span class="line"><span class="cl"><span class="nx">调用</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseField</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nx">方法，解析查询的字段。</span>  
</span></span><span class="line"><span class="cl"><span class="nx">替换</span> <span class="o">%</span><span class="nx">JOIN</span><span class="o">%</span><span class="nx">：</span>  
</span></span><span class="line"><span class="cl"><span class="nx">调用</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseJoin</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;join&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;join&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="nx">方法，解析</span>  
</span></span><span class="line"><span class="cl"><span class="nx">JOIN</span> <span class="nx">子句。</span>  
</span></span><span class="line"><span class="cl"><span class="nx">替换</span> <span class="o">%</span><span class="nx">WHERE</span><span class="o">%</span><span class="nx">：</span>  
</span></span><span class="line"><span class="cl"><span class="nx">调用</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseWhere</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;where&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;where&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="nx">方法，解析</span>  
</span></span><span class="line"><span class="cl"><span class="nx">WHERE</span> <span class="nx">子句。</span>  
</span></span><span class="line"><span class="cl"><span class="nx">替换</span> <span class="o">%</span><span class="nx">GROUP</span><span class="o">%</span><span class="nx">：</span>  
</span></span><span class="line"><span class="cl"><span class="nx">调用</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseGroup</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="nx">方法，解析</span>  
</span></span><span class="line"><span class="cl"><span class="nx">GROUP</span> <span class="nx">BY</span> <span class="nx">子句。</span>  
</span></span><span class="line"><span class="cl"><span class="nx">替换</span> <span class="o">%</span><span class="nx">HAVING</span><span class="o">%</span><span class="nx">：</span>  
</span></span><span class="line"><span class="cl"><span class="nx">调用</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseHaving</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;having&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;having&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nx">方法，解析</span> <span class="nx">HAVING</span> <span class="nx">子句。</span>  
</span></span><span class="line"><span class="cl"><span class="nx">替换</span> <span class="o">%</span><span class="nx">ORDER</span><span class="o">%</span><span class="nx">：</span>  
</span></span><span class="line"><span class="cl"><span class="nx">调用</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseOrder</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="nx">方法，解析</span>  
</span></span><span class="line"><span class="cl"><span class="nx">ORDER</span> <span class="nx">BY</span> <span class="nx">子句。</span>  
</span></span><span class="line"><span class="cl"><span class="nx">替换</span> <span class="o">%</span><span class="nx">LIMIT</span><span class="o">%</span><span class="nx">：</span>  
</span></span><span class="line"><span class="cl"><span class="nx">调用</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseLimit</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;limit&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;limit&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="nx">方法，解析</span>  
</span></span><span class="line"><span class="cl"><span class="nx">LIMIT</span> <span class="nx">子句。</span> <span class="nx">替换</span> <span class="o">%</span><span class="nx">UNION</span><span class="o">%</span><span class="nx">：</span>  
</span></span><span class="line"><span class="cl"><span class="nx">调用</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseUnion</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;union&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;union&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="nx">方法，解析</span>  
</span></span><span class="line"><span class="cl"><span class="nx">UNION</span> <span class="nx">子句。</span>  
</span></span><span class="line"><span class="cl"><span class="nx">替换</span> <span class="o">%</span><span class="nx">LOCK</span><span class="o">%</span><span class="nx">：</span>  
</span></span><span class="line"><span class="cl"><span class="nx">调用</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseLock</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;lock&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;lock&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">false</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nx">方法，解析是否加锁。</span>  
</span></span><span class="line"><span class="cl"><span class="nx">替换</span> <span class="o">%</span><span class="nx">COMMENT</span><span class="o">%</span><span class="nx">：</span>  
</span></span><span class="line"><span class="cl"><span class="nx">调用</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseComment</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nx">方法，解析注释。</span>  
</span></span><span class="line"><span class="cl"><span class="nx">替换</span> <span class="o">%</span><span class="nx">FORCE</span><span class="o">%</span><span class="nx">：</span>  
</span></span><span class="line"><span class="cl"><span class="nx">调用</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseForce</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;force&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;force&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="nx">方法，解析</span>  
</span></span><span class="line"><span class="cl"><span class="nx">FORCE</span> <span class="nx">选项。</span>  
</span></span><span class="line"><span class="cl"><span class="nx">将上述解析结果应用到</span> <span class="nx">SQL</span> <span class="nx">查询语句中。</span>  
</span></span><span class="line"><span class="cl"><span class="nx">使用</span> <span class="nx">str_replace</span> <span class="nx">函数将</span> <span class="nx">SQL</span> <span class="nx">查询语句中的占位符替换为具体的解析结果。</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>其实就是构造sql语句
生成完之后返回然后在select方法中返回查询结果
当然很明显可以知道，查询的结果是：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"> <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=&gt;</span> 
</span></span><span class="line"><span class="cl"> <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;content&#39;</span> <span class="o">=&gt;</span> 
</span></span><span class="line"><span class="cl"> <span class="nx">string</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span> <span class="s2">&#34;This is the content of the second article&#34;</span> 
</span></span><span class="line"><span class="cl"> <span class="p">}</span> 
</span></span><span class="line"><span class="cl"> <span class="p">}</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>find函数：</p>
<ul>
<li>后面的if判断都跳过了，直接到读取数据后的处理(这里的cache留个眼子，感觉有漏洞点)</li>
<li>接下来进入_read_data方法</li>
</ul>
<h3 id="function-_read_data" class="headerLink">
    <a href="#function-_read_data" class="header-mark"></a>function _read_data</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 数据读取后的处理
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @access protected
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param array $data 当前数据
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return array
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="k">function</span> <span class="nf">_read_data</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 检查字段映射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_map</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">C</span><span class="p">(</span><span class="s1">&#39;READ_DATA_MAP&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_map</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="nv">$val</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$data</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$val</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">unset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="nv">$val</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>首先检查模型类中是否定义了字段映射并且读取（READ_DATA_MAP）这个配置项，判断是否启动数据映射功能,这里是没有开启的，所以就直接跳出</p>
</li>
<li>
<p>_after_find方法没做什么操作。判断<code>result</code>键名是否存在，存在则进行<code>returnResult</code>方法，不存在则不作操作。接下来将<code>$data</code>赋值给当前对象的<code>data</code>属性</p>
</li>
<li>
<p>判断缓存cache是否存在，存在的话就利用S方法进行对缓存进行读取和写入(这里跟进也直接跳过了，因为前面也没有cache)</p>
</li>
<li>
<p>最后返回查询结果也就是当前对象刚刚被赋值为<code>$data</code></p>
</li>
</ul>
<p>然后最后也是调用了一次show方法，这个在前面已经分析过了，与上面的区别就是利用了base64_encode进行了加密输出</p></div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2024-01-22</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share"></div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/thinkphp/">Thinkphp</a>,&nbsp;<a href="/tags/php/">PHP</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/phar/" class="prev" rel="prev" title="反序列化-phar"><i class="fas fa-angle-left fa-fw"></i>反序列化-phar</a>
            <a href="/posts/knightctf-2024/" class="next" rel="next" title="Knightctf 2024 WP">Knightctf 2024 WP<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.122.0">Hugo</a>&nbsp;|&nbsp;Theme - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/ML-hacker" target="_blank" rel="noopener noreferrer">Delete</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="Back to Top">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":20},"comment":{},"data":{"desktop-header-typeit":"Delete's blog","mobile-header-typeit":"Delete's blog"},"search":{"distance":100,"findAllMatches":false,"highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"No results found","snippetLength":30,"threshold":0.3,"useExtendedSearch":false},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript" src="/js/theme.min.js" defer></script></div>
</body>

</html>
